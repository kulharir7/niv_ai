"""
Frappe/ERPNext Developer Knowledge for RAG — Developer Mode.

Indexes Frappe framework internals, DocType creation patterns,
Client/Server Script APIs, field types, and development best practices.

Usage:
    bench --site <site> execute niv_ai.niv_core.langchain.dev_knowledge.index_all_dev
    bench --site <site> execute niv_ai.niv_core.langchain.dev_knowledge.index_all_dev --kwargs "{'force': True}"
"""
import frappe


def index_all_dev(force=False):
    """Index all Frappe/ERPNext developer knowledge."""
    from .rag import delete_by_source, _reset_vectorstore

    sources = [
        "dev_field_types", "dev_doctype_creation", "dev_client_script",
        "dev_server_script", "dev_custom_field", "dev_property_setter",
        "dev_workflow", "dev_print_format", "dev_permissions",
        "dev_api_patterns", "dev_naming", "dev_child_table",
        "dev_report", "dev_page_webview", "dev_hooks",
        "dev_jinja", "dev_best_practices", "dev_fac_tool_formats",
        "dev_dashboard", "dev_phase_a_recipes", "dev_phase_b_recipes",
        "dev_phase_c_recipes", "dev_phase_def_recipes", "dev_phase_ijkl_recipes",
        "dev_markdown_guide"
    ]

    if force:
        for source in sources:
            delete_by_source(source)
        _reset_vectorstore()
        print("[DEV RAG] Cleared existing developer knowledge")

    stats = {}
    stats["field_types"] = index_field_types()
    stats["doctype_creation"] = index_doctype_creation()
    stats["client_script"] = index_client_script()
    stats["server_script"] = index_server_script()
    stats["custom_field"] = index_custom_field()
    stats["property_setter"] = index_property_setter()
    stats["workflow"] = index_workflow()
    stats["print_format"] = index_print_format()
    stats["permissions"] = index_permissions()
    stats["api_patterns"] = index_api_patterns()
    stats["naming"] = index_naming()
    stats["child_table"] = index_child_table()
    stats["report"] = index_report()
    stats["hooks"] = index_hooks()
    stats["jinja"] = index_jinja()
    stats["best_practices"] = index_best_practices()
    stats["fac_tool_formats"] = index_fac_tool_formats()
    stats["dev_dashboard"] = index_dev_dashboard()
    stats["dev_phase_a_recipes"] = index_phase_a_recipes()
    stats["dev_phase_b_recipes"] = index_phase_b_recipes()
    stats["dev_phase_c_recipes"] = index_phase_c_recipes()
    stats["dev_phase_def_recipes"] = index_phase_def_recipes()
    stats["dev_phase_ijkl_recipes"] = index_phase_ijkl_recipes()
    stats["markdown_guide"] = index_markdown_guide()

    total = sum(stats.values())
    print(f"\n[DEV RAG] === COMPLETE === Total: {total} developer knowledge chunks")
    for key, count in stats.items():
        print(f"  {key}: {count}")
    return stats


def _index_chunks(knowledge, source):
    """Helper to index a list of knowledge dicts."""
    from .rag import add_documents, delete_by_source
    delete_by_source(source)
    texts = [k["content"] for k in knowledge]
    metadatas = [{"source": source, "title": k["title"]} for k in knowledge]
    count = add_documents(texts, metadatas)
    print(f"[DEV RAG] {source}: {count} chunks")
    return count


def index_field_types():
    """Index all Frappe field types with usage and options."""
    knowledge = [
        {
            "title": "Frappe Field Types — Data Entry Fields",
            "content": (
                "Frappe Field Types — Data Entry:\n\n"
                "DATA: Single line text. Max 140 chars. Options: 'Name', 'Phone', 'Email', 'URL', 'Barcode'.\n"
                "  Example: {'fieldname': 'full_name', 'fieldtype': 'Data', 'label': 'Full Name', 'reqd': 1}\n\n"
                "SMALL TEXT: Multi-line text, no formatting. Stored as TEXT in DB.\n"
                "  Example: {'fieldname': 'address', 'fieldtype': 'Small Text', 'label': 'Address'}\n\n"
                "TEXT: Multi-line plain text. Larger than Small Text.\n\n"
                "TEXT EDITOR: Rich text with HTML formatting toolbar. Stored as LONGTEXT.\n"
                "  Example: {'fieldname': 'description', 'fieldtype': 'Text Editor', 'label': 'Description'}\n\n"
                "LONG TEXT: Very large text. No editor toolbar. For logs, JSON, raw content.\n\n"
                "CODE: Syntax-highlighted code editor. Options: 'Python', 'JavaScript', 'HTML', 'CSS', 'JSON', 'Markdown'.\n"
                "  Example: {'fieldname': 'script', 'fieldtype': 'Code', 'options': 'Python', 'label': 'Script'}\n\n"
                "MARKDOWN EDITOR: Markdown with preview. Rendered as HTML.\n\n"
                "PASSWORD: Encrypted field. Never shown in API responses. Stored encrypted in DB.\n"
                "  Example: {'fieldname': 'api_secret', 'fieldtype': 'Password', 'label': 'API Secret'}\n\n"
                "READ ONLY: Display-only text field. Cannot be edited by user.\n\n"
                "INT: Integer number. Stored as INT(11) in DB.\n"
                "  Example: {'fieldname': 'quantity', 'fieldtype': 'Int', 'label': 'Quantity', 'default': '0'}\n\n"
                "FLOAT: Decimal number. Stored as DECIMAL(21,9).\n"
                "  Example: {'fieldname': 'rate', 'fieldtype': 'Float', 'label': 'Rate', 'precision': '2'}\n\n"
                "CURRENCY: Money field with currency symbol. Respects global currency settings.\n"
                "  Options can be a fieldname that holds currency code.\n"
                "  Example: {'fieldname': 'grand_total', 'fieldtype': 'Currency', 'options': 'currency', 'label': 'Grand Total'}\n\n"
                "PERCENT: 0-100 percentage. Shows % sign.\n\n"
                "CHECK: Boolean checkbox. 0 or 1 in DB.\n"
                "  Example: {'fieldname': 'is_active', 'fieldtype': 'Check', 'label': 'Is Active', 'default': '1'}\n\n"
                "RATING: Star rating (0-1 in 0.2 increments = 5 stars).\n"
                "  Example: {'fieldname': 'rating', 'fieldtype': 'Rating', 'options': '5'}"
            ),
        },
        {
            "title": "Frappe Field Types — Date, Time, Select, Link",
            "content": (
                "Frappe Field Types — Date/Time/Select/Link:\n\n"
                "DATE: Date picker. Format: YYYY-MM-DD in DB.\n"
                "  Example: {'fieldname': 'posting_date', 'fieldtype': 'Date', 'label': 'Posting Date', 'default': 'Today'}\n\n"
                "DATETIME: Date + time picker. Format: YYYY-MM-DD HH:MM:SS.\n"
                "  Example: {'fieldname': 'scheduled_at', 'fieldtype': 'Datetime', 'label': 'Scheduled At'}\n\n"
                "TIME: Time picker. Format: HH:MM:SS.\n\n"
                "DURATION: Time duration in seconds. Shows as HH:MM:SS.\n"
                "  Options: 'hide_days' to hide day count.\n\n"
                "SELECT: Dropdown. Options: newline-separated values.\n"
                "  Example: {'fieldname': 'status', 'fieldtype': 'Select', 'label': 'Status',\n"
                "    'options': 'Draft\\nPending\\nApproved\\nRejected', 'default': 'Draft'}\n\n"
                "LINK: Foreign key to another DocType. Options = DocType name.\n"
                "  Example: {'fieldname': 'customer', 'fieldtype': 'Link', 'options': 'Customer',\n"
                "    'label': 'Customer', 'reqd': 1}\n\n"
                "DYNAMIC LINK: Link where DocType is determined by another field.\n"
                "  Options = fieldname that holds the DocType.\n"
                "  Example: {'fieldname': 'party', 'fieldtype': 'Dynamic Link', 'options': 'party_type'}\n"
                "  Used with: {'fieldname': 'party_type', 'fieldtype': 'Link', 'options': 'DocType'}\n\n"
                "TABLE: Child table. Options = child DocType name.\n"
                "  Example: {'fieldname': 'items', 'fieldtype': 'Table', 'options': 'Sales Order Item',\n"
                "    'label': 'Items', 'reqd': 1}\n\n"
                "TABLE MULTISELECT: Multi-select via child table with Link field.\n"
                "  Options = child DocType that has a Link field.\n"
                "  Example: {'fieldname': 'roles', 'fieldtype': 'Table MultiSelect', 'options': 'Has Role'}\n\n"
                "ATTACH: File attachment. Single file upload.\n"
                "  Example: {'fieldname': 'logo', 'fieldtype': 'Attach', 'label': 'Logo'}\n\n"
                "ATTACH IMAGE: Image upload with preview.\n"
                "  Example: {'fieldname': 'photo', 'fieldtype': 'Attach Image', 'label': 'Photo'}\n\n"
                "COLOR: Color picker. Stores hex code (#RRGGBB).\n\n"
                "GEOLOCATION: Map with lat/long. Stores GeoJSON.\n\n"
                "SIGNATURE: Digital signature pad. Stores as base64 image.\n\n"
                "JSON: JSON editor field. Stored as LONGTEXT."
            ),
        },
        {
            "title": "Frappe Field Types — Layout & Display Fields",
            "content": (
                "Frappe Layout & Display Fields (no data stored in DB):\n\n"
                "SECTION BREAK: Creates a new section. label becomes section heading.\n"
                "  Options: 'collapsible' = 1 to make it collapsible.\n"
                "  Example: {'fieldname': 'address_section', 'fieldtype': 'Section Break', 'label': 'Address Details',\n"
                "    'collapsible': 1}\n\n"
                "COLUMN BREAK: Splits section into columns. Creates a new column.\n"
                "  Example: {'fieldname': 'column_break_1', 'fieldtype': 'Column Break'}\n\n"
                "TAB BREAK: Creates a new tab (v14+). label = tab name.\n"
                "  Example: {'fieldname': 'details_tab', 'fieldtype': 'Tab Break', 'label': 'Details'}\n\n"
                "HTML: Renders raw HTML. Options = HTML content or fieldname.\n"
                "  Example: {'fieldname': 'help_html', 'fieldtype': 'HTML', 'options': '<p>Help text here</p>'}\n\n"
                "IMAGE: Displays image from another field. Options = fieldname that holds image URL.\n"
                "  Example: {'fieldname': 'preview', 'fieldtype': 'Image', 'options': 'photo'}\n\n"
                "HEADING: Large text heading. Deprecated — use Section Break instead.\n\n"
                "BUTTON: Clickable button. Triggers Client Script event.\n"
                "  Example: {'fieldname': 'sync_btn', 'fieldtype': 'Button', 'label': 'Sync Now'}\n"
                "  In Client Script: frm.fields_dict.sync_btn.input.onclick = function() { ... }\n\n"
                "ICON: Icon display field.\n\n"
                "LAYOUT BEST PRACTICES:\n"
                "- Always start with a Section Break (even implicit)\n"
                "- Use Column Break for 2-column layouts within a section\n"
                "- Use Tab Break for organizing many fields (v14+)\n"
                "- Standard pattern: Section → Field → Column Break → Field\n"
                "- Maximum 2 columns per section recommended\n"
                "- Group related fields in collapsible sections\n"
                "- Put mandatory fields in the first tab/section"
            ),
        },
        {
            "title": "Frappe Field Properties — Complete Reference",
            "content": (
                "Frappe Field Properties (applicable to all field types):\n\n"
                "REQUIRED PROPERTIES:\n"
                "- fieldname: Snake_case, unique within DocType. Auto-generated from label.\n"
                "- fieldtype: One of the valid field types.\n"
                "- label: Display label (Title Case).\n\n"
                "COMMON PROPERTIES:\n"
                "- reqd: 1 = mandatory field, 0 = optional.\n"
                "- default: Default value. Special: 'Today', 'Now', '__user', frappe.defaults.\n"
                "- hidden: 1 = hidden from form (still in DB).\n"
                "- read_only: 1 = not editable on form.\n"
                "- unique: 1 = unique constraint in DB.\n"
                "- set_only_once: 1 = editable only on first save.\n"
                "- allow_on_submit: 1 = editable even after submit.\n"
                "- in_list_view: 1 = show in list view columns.\n"
                "- in_standard_filter: 1 = show in sidebar filters.\n"
                "- in_global_search: 1 = included in global search.\n"
                "- bold: 1 = bold label.\n"
                "- description: Help text shown below field.\n"
                "- depends_on: JS expression — show/hide field. Example: 'eval:doc.status==\"Approved\"'\n"
                "- mandatory_depends_on: Make mandatory conditionally.\n"
                "- read_only_depends_on: Make read-only conditionally.\n"
                "- fetch_from: Auto-fetch from linked document. Example: 'customer.customer_name'\n"
                "- fetch_if_empty: 1 = fetch only if field is empty.\n"
                "- options: Depends on fieldtype (Select options, Link DocType, etc.).\n"
                "- precision: Decimal places for Float/Currency.\n"
                "- length: Max length for Data fields.\n"
                "- translatable: 1 = can be translated.\n"
                "- no_copy: 1 = not copied on duplicate.\n"
                "- print_hide: 1 = hidden in print format.\n"
                "- report_hide: 1 = hidden in reports.\n"
                "- allow_in_quick_entry: 1 = show in quick entry dialog.\n"
                "- permlevel: Permission level (0-9). Higher = more restricted.\n"
                "- columns: Width in list view (1-10).\n\n"
                "SPECIAL DEFAULTS:\n"
                "- 'Today' → current date\n"
                "- 'Now' → current datetime\n"
                "- '__user' → current user (for Link to User)\n"
                "- '{field_name}' → value from Frappe Defaults"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_field_types")


def index_doctype_creation():
    """Index DocType creation patterns and rules."""
    knowledge = [
        {
            "title": "How to Create a DocType in Frappe",
            "content": (
                "Creating a DocType in Frappe:\n\n"
                "METHOD 1 — VIA UI (Recommended for developer mode):\n"
                "1. Go to /app/doctype/new-doctype-1\n"
                "2. Or: frappe.new_doc('DocType') in console\n\n"
                "METHOD 2 — VIA CODE (create_document tool):\n"
                "create_document(doctype='DocType', values={\n"
                "  'name': 'Student',         # Auto-set from module + name\n"
                "  'module': 'Custom',         # Module it belongs to\n"
                "  'naming_rule': 'By fieldname',  # or 'Autoincrement', 'By Naming Series', etc.\n"
                "  'autoname': 'field:student_name',  # Naming pattern\n"
                "  'is_submittable': 0,        # 1 = has Submit/Cancel workflow\n"
                "  'is_tree': 0,               # 1 = hierarchical (parent-child)\n"
                "  'is_calendar_and_gantt': 0, # 1 = show in calendar\n"
                "  'istable': 0,               # 1 = child table DocType\n"
                "  'issingle': 0,              # 1 = single record (like Settings)\n"
                "  'quick_entry': 1,           # 1 = show quick entry dialog\n"
                "  'track_changes': 1,         # 1 = version history\n"
                "  'fields': [\n"
                "    {'fieldname': 'student_name', 'fieldtype': 'Data', 'label': 'Student Name',\n"
                "     'reqd': 1, 'in_list_view': 1},\n"
                "    {'fieldname': 'roll_no', 'fieldtype': 'Data', 'label': 'Roll Number', 'unique': 1},\n"
                "    {'fieldname': 'section_break_1', 'fieldtype': 'Section Break', 'label': 'Details'},\n"
                "    {'fieldname': 'class_name', 'fieldtype': 'Link', 'options': 'Class',\n"
                "     'label': 'Class'},\n"
                "    {'fieldname': 'column_break_1', 'fieldtype': 'Column Break'},\n"
                "    {'fieldname': 'date_of_birth', 'fieldtype': 'Date', 'label': 'Date of Birth'},\n"
                "    {'fieldname': 'gender', 'fieldtype': 'Select',\n"
                "     'options': 'Male\\nFemale\\nOther', 'label': 'Gender'},\n"
                "    {'fieldname': 'contact_section', 'fieldtype': 'Section Break',\n"
                "     'label': 'Contact', 'collapsible': 1},\n"
                "    {'fieldname': 'email', 'fieldtype': 'Data', 'options': 'Email', 'label': 'Email'},\n"
                "    {'fieldname': 'mobile', 'fieldtype': 'Data', 'options': 'Phone', 'label': 'Mobile'},\n"
                "  ],\n"
                "  'permissions': [\n"
                "    {'role': 'System Manager', 'read': 1, 'write': 1, 'create': 1, 'delete': 1},\n"
                "    {'role': 'All', 'read': 1}\n"
                "  ]\n"
                "})\n\n"
                "AFTER CREATION:\n"
                "- Run: bench --site <site> migrate (creates DB table)\n"
                "- Or: frappe.db.commit() if using console\n\n"
                "NAMING RULES:\n"
                "- 'Autoincrement': 1, 2, 3...\n"
                "- 'By fieldname': Uses a field value as name (autoname='field:student_name')\n"
                "- 'By Naming Series': Prefix-based (autoname='STU-.YYYY.-.#####')\n"
                "- 'Set by user': User types the name\n"
                "- 'By script': autoname method in controller\n"
                "- 'Random': Random hash\n"
                "- 'By Expression': autoname='format:STU-{student_name}-{###}'"
            ),
        },
        {
            "title": "DocType Types — Regular, Single, Child, Submittable, Virtual",
            "content": (
                "DocType Types in Frappe:\n\n"
                "1. REGULAR DOCTYPE (default):\n"
                "   - Multiple records, each with unique name\n"
                "   - Has list view, form view\n"
                "   - issingle=0, istable=0\n"
                "   - Example: Customer, Item, Sales Order\n\n"
                "2. SINGLE DOCTYPE (issingle=1):\n"
                "   - Only ONE record exists (like Settings)\n"
                "   - No list view, direct form\n"
                "   - Access: frappe.get_single('Niv Settings')\n"
                "   - Example: Website Settings, System Settings\n"
                "   - To create: set issingle=1\n\n"
                "3. CHILD TABLE (istable=1):\n"
                "   - Used inside other DocTypes as Table field\n"
                "   - No independent form/list view\n"
                "   - Must have 'parent', 'parenttype', 'parentfield' (auto-added)\n"
                "   - Example: Sales Order Item, Address\n"
                "   - To create: set istable=1, add fields, use in parent via Table fieldtype\n\n"
                "4. SUBMITTABLE (is_submittable=1):\n"
                "   - Has Submit/Cancel workflow\n"
                "   - Status: Draft (0) → Submitted (1) → Cancelled (2)\n"
                "   - Submitted docs are read-only (except allow_on_submit fields)\n"
                "   - Adds 'docstatus' field and 'amended_from' for amendments\n"
                "   - Example: Sales Invoice, Journal Entry\n\n"
                "5. TREE DOCTYPE (is_tree=1):\n"
                "   - Hierarchical parent-child structure\n"
                "   - Auto-adds: parent_<doctype>, lft, rgt, old_parent, is_group\n"
                "   - Shows as tree in list view\n"
                "   - Example: Account, Department, Territory\n\n"
                "6. VIRTUAL DOCTYPE (is_virtual=1, v15+):\n"
                "   - No DB table created\n"
                "   - Data comes from controller methods\n"
                "   - Useful for dynamic/computed data\n\n"
                "COMMON SETTINGS:\n"
                "- module: Which module (for permissions, organization)\n"
                "- sort_field: Default sort (default: 'modified')\n"
                "- sort_order: 'ASC' or 'DESC'\n"
                "- title_field: Field used as document title\n"
                "- image_field: Field for thumbnail image\n"
                "- search_fields: Fields included in search (comma-separated)\n"
                "- default_print_format: Default print format name"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_doctype_creation")


def index_client_script():
    """Index Client Script patterns and API."""
    knowledge = [
        {
            "title": "Client Script — Complete API Reference",
            "content": (
                "Client Script (Form Scripts) — Runs in browser on form events:\n\n"
                "DocType: Client Script\n"
                "Fields: dt (target DocType), script_type (Class/API), script (code)\n\n"
                "CREATE VIA:\n"
                "create_document(doctype='Client Script', values={\n"
                "  'dt': 'Sales Order',\n"
                "  'script_type': 'Class',\n"
                "  'enabled': 1,\n"
                "  'script': '<your JS code>'\n"
                "})\n\n"
                "EVENT HANDLERS (inside frappe.ui.form.on('DocType', {...})):\n"
                "- setup(frm): First load, before rendering\n"
                "- onload(frm): On form load\n"
                "- refresh(frm): On form refresh (most common)\n"
                "- validate(frm): Before save (client-side validation)\n"
                "- before_save(frm): Just before saving\n"
                "- after_save(frm): After save completes\n"
                "- before_submit(frm): Before submission\n"
                "- after_submit(frm): After submission\n"
                "- before_cancel(frm): Before cancellation\n"
                "- on_submit(frm): On successful submit\n"
                "- <fieldname>(frm): When field value changes\n"
                "- <fieldname>_on_form_rendered(frm, cdt, cdn): Child table row render\n\n"
                "EXAMPLE — Auto-fill on field change:\n"
                "frappe.ui.form.on('Sales Order', {\n"
                "  customer(frm) {\n"
                "    if (frm.doc.customer) {\n"
                "      frappe.db.get_value('Customer', frm.doc.customer, 'customer_group')\n"
                "        .then(r => {\n"
                "          frm.set_value('customer_group', r.message.customer_group);\n"
                "        });\n"
                "    }\n"
                "  }\n"
                "});\n\n"
                "EXAMPLE — Add custom button:\n"
                "frappe.ui.form.on('Sales Order', {\n"
                "  refresh(frm) {\n"
                "    if (frm.doc.docstatus === 1) {\n"
                "      frm.add_custom_button('Generate Invoice', () => {\n"
                "        frappe.call({\n"
                "          method: 'erpnext.selling.doctype.sales_order.sales_order.make_sales_invoice',\n"
                "          args: { source_name: frm.doc.name },\n"
                "          callback: (r) => { frappe.set_route('Form', 'Sales Invoice', r.message.name); }\n"
                "        });\n"
                "      }, 'Create');\n"
                "    }\n"
                "  }\n"
                "});"
            ),
        },
        {
            "title": "Client Script — frm API Methods",
            "content": (
                "frm (Form) API Methods — Client Script:\n\n"
                "VALUE OPERATIONS:\n"
                "- frm.set_value(fieldname, value): Set field value\n"
                "- frm.doc.fieldname: Read field value\n"
                "- frm.get_field(fieldname): Get field object\n"
                "- frm.refresh_field(fieldname): Re-render a field\n"
                "- frm.refresh_fields(): Re-render all fields\n\n"
                "VISIBILITY:\n"
                "- frm.toggle_display(fieldname, show): Show/hide field\n"
                "- frm.toggle_display(['field1', 'field2'], show): Multiple fields\n"
                "- frm.toggle_reqd(fieldname, reqd): Make mandatory/optional\n"
                "- frm.toggle_enable(fieldname, enable): Enable/disable field\n"
                "- frm.set_df_property(fieldname, property, value): Set any display property\n"
                "  Properties: hidden, read_only, reqd, label, options, description\n\n"
                "QUERY FILTERS (for Link fields):\n"
                "- frm.set_query(fieldname, () => { return { filters: { status: 'Active' } }; });\n"
                "- frm.set_query('item_code', 'items', () => { return { filters: {...} }; });\n"
                "  (second arg is child table fieldname)\n\n"
                "CHILD TABLE:\n"
                "- frm.add_child('items', { item_code: 'ITEM-001', qty: 5 }): Add row\n"
                "- frm.clear_table('items'): Remove all rows\n"
                "- frm.doc.items: Access child table rows\n"
                "- frm.refresh_field('items'): Refresh table display\n\n"
                "CUSTOM BUTTONS:\n"
                "- frm.add_custom_button(label, callback, group): Add button\n"
                "- frm.remove_custom_button(label, group): Remove button\n"
                "- frm.clear_custom_buttons(): Remove all\n"
                "- frm.page.set_primary_action(label, callback): Primary button\n"
                "- frm.page.set_secondary_action(label, callback): Secondary button\n\n"
                "ALERTS & MESSAGES:\n"
                "- frm.dashboard.set_headline('msg'): Top banner\n"
                "- frm.set_intro('msg', 'blue'): Intro message (blue/green/yellow/red)\n"
                "- frappe.msgprint('msg'): Message dialog\n"
                "- frappe.show_alert({message: 'msg', indicator: 'green'}): Toast\n"
                "- frappe.confirm('Are you sure?', () => { yes }, () => { no }): Confirm dialog\n"
                "- frappe.throw('Error!'): Error and stop execution\n\n"
                "SAVE & WORKFLOW:\n"
                "- frm.save(): Save document\n"
                "- frm.save_or_update(): Save or update\n"
                "- frm.amend_doc(): Create amendment\n"
                "- frm.reload_doc(): Reload from server\n"
                "- frm.dirty(): Check if modified\n"
                "- frm.is_new(): Check if new (unsaved)"
            ),
        },
        {
            "title": "Client Script — frappe Global API",
            "content": (
                "frappe Global API for Client Scripts:\n\n"
                "SERVER CALLS:\n"
                "- frappe.call({method, args, callback, async}): Call whitelisted API\n"
                "- frappe.xcall(method, args): Promise-based call\n"
                "- frappe.db.get_value(doctype, name, fieldname).then(r => {})\n"
                "- frappe.db.get_list(doctype, {filters, fields, limit}).then(r => {})\n"
                "- frappe.db.count(doctype, {filters}).then(r => {})\n"
                "- frappe.db.exists(doctype, name).then(r => {})\n"
                "- frappe.db.insert({doctype, ...}).then(doc => {})\n"
                "- frappe.db.set_value(doctype, name, fieldname, value)\n\n"
                "ROUTING:\n"
                "- frappe.set_route('Form', 'Sales Order', 'SO-001'): Navigate to form\n"
                "- frappe.set_route('List', 'Customer'): Navigate to list\n"
                "- frappe.set_route('app', 'sales-order', 'new'): New document\n"
                "- frappe.route_options = { customer: 'ABC' }: Pre-fill on next route\n\n"
                "DIALOGS:\n"
                "- new frappe.ui.Dialog({title, fields, primary_action}): Custom dialog\n"
                "- frappe.prompt([{fieldname, fieldtype, label}], callback, title): Quick input\n"
                "- frappe.confirm(msg, yes_callback, no_callback)\n\n"
                "UTILITIES:\n"
                "- frappe.format(value, {fieldtype: 'Currency'}): Format value\n"
                "- frappe.datetime.now_datetime(): Current datetime\n"
                "- frappe.datetime.add_days(date, days): Date arithmetic\n"
                "- frappe.datetime.get_diff(date1, date2): Days difference\n"
                "- frappe.user.has_role('System Manager'): Check role\n"
                "- frappe.session.user: Current user email\n"
                "- frappe.boot.sysdefaults: System defaults\n"
                "- cur_frm: Current form object (global)"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_client_script")


def index_server_script():
    """Index Server Script patterns and API."""
    knowledge = [
        {
            "title": "Server Script — Complete Guide",
            "content": (
                "Server Script — Runs on server (Python sandbox):\n\n"
                "DocType: Server Script\n"
                "Types: DocType Event, API, Permission Query, Scheduler Event\n\n"
                "CREATE VIA:\n"
                "create_document(doctype='Server Script', values={\n"
                "  'name': 'my_script',\n"
                "  'script_type': 'DocType Event',  # or 'API', 'Permission Query', 'Scheduler Event'\n"
                "  'reference_doctype': 'Sales Order',  # for DocType Event\n"
                "  'doctype_event': 'Before Save',  # event type\n"
                "  'script': '<python code>',\n"
                "  'enabled': 1\n"
                "})\n\n"
                "DOCTYPE EVENT TYPES:\n"
                "- Before Insert: Before first save (doc.name not set yet)\n"
                "- After Insert: After first save\n"
                "- Before Validate: Before validation (runs on every save)\n"
                "- Before Save: Just before saving\n"
                "- After Save: After save completes\n"
                "- Before Submit: Before submission\n"
                "- After Submit: After submission\n"
                "- Before Cancel: Before cancellation\n"
                "- After Cancel: After cancellation\n"
                "- Before Delete: Before deletion\n"
                "- After Delete: After deletion\n"
                "- On Change: Any change (save, submit, cancel, amend)\n\n"
                "AVAILABLE IN SCRIPT:\n"
                "- doc: The document being processed\n"
                "- frappe: The frappe module\n"
                "- frappe.db: Database access\n"
                "- frappe.utils: Utility functions\n"
                "- frappe.session: Session info (user, etc.)\n"
                "- frappe.throw(): Raise error and stop\n"
                "- frappe.msgprint(): Show message\n"
                "- frappe.sendmail(): Send email\n\n"
                "EXAMPLE — Validate before save:\n"
                "# DocType Event: Before Save on Sales Order\n"
                "if doc.grand_total > 100000:\n"
                "    if not frappe.db.exists('User Permission', {\n"
                "        'user': frappe.session.user,\n"
                "        'allow': 'Company',\n"
                "        'for_value': doc.company\n"
                "    }):\n"
                "        frappe.throw('Orders above 1 Lakh need approval')\n\n"
                "EXAMPLE — Auto-set field:\n"
                "# Before Save on Purchase Order\n"
                "if doc.items:\n"
                "    doc.total_qty = sum(item.qty for item in doc.items)\n\n"
                "EXAMPLE — Send email after submit:\n"
                "# After Submit on Sales Invoice\n"
                "frappe.sendmail(\n"
                "    recipients=[doc.contact_email],\n"
                "    subject=f'Invoice {doc.name} Created',\n"
                "    message=f'Your invoice for {doc.grand_total} has been created.'\n"
                ")\n\n"
                "API TYPE:\n"
                "# Accessible via /api/method/<script_name>\n"
                "# 'api_method' field = URL name\n"
                "# Input: frappe.form_dict\n"
                "# Output: frappe.response['message'] = result"
            ),
        },
        {
            "title": "Server Script — frappe Python API",
            "content": (
                "frappe Python API (available in Server Scripts & controllers):\n\n"
                "DOCUMENT OPERATIONS:\n"
                "- frappe.get_doc(doctype, name): Get document\n"
                "- frappe.new_doc(doctype): Create new document\n"
                "- frappe.get_doc({doctype, ...}).insert(): Create and insert\n"
                "- doc.save(): Save document\n"
                "- doc.submit(): Submit document\n"
                "- doc.cancel(): Cancel document\n"
                "- doc.delete(): Delete document\n"
                "- doc.as_dict(): Convert to dictionary\n"
                "- doc.reload(): Reload from DB\n\n"
                "DATABASE:\n"
                "- frappe.db.get_value(doctype, name, fieldname): Get single value\n"
                "- frappe.db.get_list(doctype, filters, fields, limit): Get list\n"
                "- frappe.db.get_all(doctype, filters, fields): Get all (ignore permissions)\n"
                "- frappe.db.count(doctype, filters): Count records\n"
                "- frappe.db.exists(doctype, name): Check existence\n"
                "- frappe.db.set_value(doctype, name, fieldname, value): Update field\n"
                "- frappe.db.sql(query, values, as_dict): Raw SQL\n"
                "- frappe.db.commit(): Commit transaction\n\n"
                "UTILITIES:\n"
                "- frappe.utils.now(): Current datetime string\n"
                "- frappe.utils.today(): Today's date string\n"
                "- frappe.utils.add_days(date, days): Date arithmetic\n"
                "- frappe.utils.date_diff(date1, date2): Days between\n"
                "- frappe.utils.getdate(string): Parse date\n"
                "- frappe.utils.flt(value, precision): Float with precision\n"
                "- frappe.utils.cint(value): Convert to int\n"
                "- frappe.utils.cstr(value): Convert to string\n"
                "- frappe.utils.fmt_money(amount, currency): Format currency\n\n"
                "PERMISSIONS:\n"
                "- frappe.has_permission(doctype, ptype, doc): Check permission\n"
                "- frappe.only_for(roles): Restrict to roles (throws if no match)\n"
                "- frappe.session.user: Current user email\n"
                "- frappe.get_roles(): Current user's roles\n\n"
                "EMAIL:\n"
                "- frappe.sendmail(recipients, subject, message, template, args)\n"
                "- frappe.enqueue('frappe.email...', queue='short'): Queue email\n\n"
                "BACKGROUND JOBS:\n"
                "- frappe.enqueue(method, queue, timeout, **kwargs): Queue job\n"
                "- Queues: 'short' (5min), 'default' (5min), 'long' (30min)\n\n"
                "CACHE:\n"
                "- frappe.cache().get_value(key): Get cached value\n"
                "- frappe.cache().set_value(key, value, expires_in_sec=300): Set with TTL\n"
                "- frappe.cache().delete_value(key): Delete"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_server_script")


def index_custom_field():
    """Index Custom Field creation patterns."""
    knowledge = [
        {
            "title": "Custom Field — Add Fields Without Touching Core",
            "content": (
                "Custom Field — Safe way to add fields to any DocType:\n\n"
                "DocType: Custom Field\n"
                "Module: Core\n\n"
                "WHY CUSTOM FIELD?\n"
                "- Adds fields without modifying core DocType JSON\n"
                "- Survives bench update / app upgrades\n"
                "- Can be exported as fixtures\n"
                "- Best practice for extending standard DocTypes\n\n"
                "CREATE VIA:\n"
                "create_document(doctype='Custom Field', values={\n"
                "  'dt': 'Sales Order',           # Target DocType\n"
                "  'fieldname': 'custom_discount_reason',\n"
                "  'fieldtype': 'Data',\n"
                "  'label': 'Discount Reason',\n"
                "  'insert_after': 'discount_amount',  # Position after this field\n"
                "  'reqd': 0,\n"
                "  'description': 'Reason for giving discount',\n"
                "  'depends_on': 'eval:doc.discount_amount > 0'\n"
                "})\n\n"
                "IMPORTANT RULES:\n"
                "- fieldname MUST start with 'custom_' (auto-prefixed if not)\n"
                "- insert_after: fieldname to place after (determines position)\n"
                "- All standard field properties work (reqd, hidden, depends_on, etc.)\n"
                "- After creation: bench migrate (or auto on save in UI)\n\n"
                "ADDING TO CHILD TABLE:\n"
                "create_document(doctype='Custom Field', values={\n"
                "  'dt': 'Sales Order Item',      # Child table DocType\n"
                "  'fieldname': 'custom_batch_no',\n"
                "  'fieldtype': 'Data',\n"
                "  'label': 'Batch Number',\n"
                "  'in_list_view': 1               # Show in table view\n"
                "})\n\n"
                "COMMON USE CASES:\n"
                "- Adding company-specific fields to standard DocTypes\n"
                "- Adding tracking/reference fields\n"
                "- Adding computed/display fields\n"
                "- Extending child tables with extra columns"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_custom_field")


def index_property_setter():
    """Index Property Setter patterns."""
    knowledge = [
        {
            "title": "Property Setter — Modify Existing Field Properties",
            "content": (
                "Property Setter — Change properties of existing fields:\n\n"
                "DocType: Property Setter\n"
                "Module: Core\n\n"
                "WHY PROPERTY SETTER?\n"
                "- Change label, default, hidden, reqd etc. without editing DocType\n"
                "- Survives app updates\n"
                "- Can change DocType-level properties too\n\n"
                "CREATE VIA:\n"
                "create_document(doctype='Property Setter', values={\n"
                "  'doctype_or_field': 'DocField',  # 'DocField' for field props, 'DocType' for doctype props\n"
                "  'doc_type': 'Sales Order',       # Target DocType\n"
                "  'field_name': 'customer',        # Target field (null for DocType props)\n"
                "  'property': 'reqd',              # Property to change\n"
                "  'property_type': 'Check',        # Type of the property value\n"
                "  'value': '1'                     # New value (always string)\n"
                "})\n\n"
                "COMMON FIELD PROPERTIES TO CHANGE:\n"
                "- label: Change display label\n"
                "- reqd: Make mandatory (1) or optional (0)\n"
                "- hidden: Hide (1) or show (0)\n"
                "- read_only: Read only (1) or editable (0)\n"
                "- default: Change default value\n"
                "- options: Change Select options or Link target\n"
                "- description: Change help text\n"
                "- in_list_view: Show in list (1) or hide (0)\n"
                "- in_standard_filter: Add to filters (1)\n"
                "- depends_on: Conditional visibility expression\n"
                "- mandatory_depends_on: Conditional mandatory\n"
                "- allow_on_submit: Allow editing after submit\n"
                "- fetch_from: Auto-fetch from linked doc\n"
                "- precision: Decimal places\n"
                "- print_hide: Hide in print\n\n"
                "DOCTYPE-LEVEL PROPERTIES:\n"
                "Set doctype_or_field='DocType', field_name=None:\n"
                "- sort_field, sort_order\n"
                "- search_fields\n"
                "- title_field\n"
                "- image_field\n"
                "- default_print_format\n"
                "- quick_entry\n"
                "- track_changes\n\n"
                "EXAMPLE — Hide a field:\n"
                "create_document(doctype='Property Setter', values={\n"
                "  'doctype_or_field': 'DocField',\n"
                "  'doc_type': 'Sales Order',\n"
                "  'field_name': 'tax_id',\n"
                "  'property': 'hidden',\n"
                "  'property_type': 'Check',\n"
                "  'value': '1'\n"
                "})\n\n"
                "EXAMPLE — Change default value:\n"
                "create_document(doctype='Property Setter', values={\n"
                "  'doctype_or_field': 'DocField',\n"
                "  'doc_type': 'Sales Order',\n"
                "  'field_name': 'delivery_date',\n"
                "  'property': 'default',\n"
                "  'property_type': 'Text',\n"
                "  'value': 'Today'\n"
                "})"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_property_setter")


def index_workflow():
    """Index Workflow creation patterns."""
    knowledge = [
        {
            "title": "Workflow — Multi-Level Approval System",
            "content": (
                "Workflow in Frappe — Approval chains and state machines:\n\n"
                "DocType: Workflow\n\n"
                "CREATE VIA:\n"
                "create_document(doctype='Workflow', values={\n"
                "  'workflow_name': 'Leave Approval',\n"
                "  'document_type': 'Leave Application',\n"
                "  'is_active': 1,\n"
                "  'override_status': 0,\n"
                "  'workflow_state_field': 'workflow_state',  # field to store state\n"
                "  'states': [\n"
                "    {'state': 'Pending', 'doc_status': '0', 'allow_edit': 'Employee',\n"
                "     'style': 'Warning'},\n"
                "    {'state': 'Approved by Manager', 'doc_status': '0',\n"
                "     'allow_edit': 'HR Manager', 'style': 'Primary'},\n"
                "    {'state': 'Approved', 'doc_status': '1', 'allow_edit': 'HR Manager',\n"
                "     'style': 'Success', 'update_field': 'status', 'update_value': 'Approved'},\n"
                "    {'state': 'Rejected', 'doc_status': '1', 'allow_edit': 'HR Manager',\n"
                "     'style': 'Danger', 'update_field': 'status', 'update_value': 'Rejected'}\n"
                "  ],\n"
                "  'transitions': [\n"
                "    {'state': 'Pending', 'action': 'Approve', 'next_state': 'Approved by Manager',\n"
                "     'allowed': 'HR User', 'allow_self_approval': 0},\n"
                "    {'state': 'Pending', 'action': 'Reject', 'next_state': 'Rejected',\n"
                "     'allowed': 'HR User'},\n"
                "    {'state': 'Approved by Manager', 'action': 'Final Approve',\n"
                "     'next_state': 'Approved', 'allowed': 'HR Manager'},\n"
                "    {'state': 'Approved by Manager', 'action': 'Reject',\n"
                "     'next_state': 'Rejected', 'allowed': 'HR Manager'}\n"
                "  ]\n"
                "})\n\n"
                "STATE PROPERTIES:\n"
                "- state: State name\n"
                "- doc_status: 0=Draft, 1=Submitted, 2=Cancelled\n"
                "- allow_edit: Role that can edit in this state\n"
                "- style: Warning/Primary/Success/Danger/Info/Inverse\n"
                "- update_field/update_value: Auto-update a field on entering state\n\n"
                "TRANSITION PROPERTIES:\n"
                "- state: From state\n"
                "- action: Button label shown to user\n"
                "- next_state: Target state\n"
                "- allowed: Role that can perform this action\n"
                "- allow_self_approval: 0 = cannot approve own docs\n"
                "- condition: JS expression for conditional transition\n\n"
                "NOTES:\n"
                "- Only ONE active workflow per DocType\n"
                "- workflow_state field must exist on the DocType (auto-created or Custom Field)\n"
                "- doc_status changes on transitions (Draft→Submitted→Cancelled)\n"
                "- Workflow overrides the normal Submit/Cancel buttons"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_workflow")


def index_print_format():
    """Index Print Format creation patterns."""
    knowledge = [
        {
            "title": "Print Format — Custom Document Printing",
            "content": (
                "Print Format in Frappe — Custom document layouts for printing/PDF:\n\n"
                "DocType: Print Format\n\n"
                "TYPES:\n"
                "1. Jinja (HTML template — most flexible)\n"
                "2. JS (legacy, deprecated)\n"
                "3. Standard (auto-generated from DocType fields)\n\n"
                "CREATE VIA:\n"
                "create_document(doctype='Print Format', values={\n"
                "  'name': 'Custom Sales Invoice',\n"
                "  'doc_type': 'Sales Invoice',\n"
                "  'module': 'Accounts',\n"
                "  'print_format_type': 'Jinja',\n"
                "  'standard': 'No',\n"
                "  'custom_format': 1,\n"
                "  'html': '<your jinja HTML template>'\n"
                "})\n\n"
                "JINJA TEMPLATE VARIABLES:\n"
                "- doc: The document object (all fields accessible)\n"
                "- doc.items: Child table rows\n"
                "- doc.name, doc.customer, doc.grand_total etc.\n"
                "- frappe.utils.fmt_money(amount): Format currency\n"
                "- frappe.utils.formatdate(date): Format date\n"
                "- frappe.get_print_style(): Default print CSS\n"
                "- nowrap, visible_columns: Print helpers\n\n"
                "EXAMPLE TEMPLATE:\n"
                "<div class='print-format'>\n"
                "  <h2>{{ doc.company }}</h2>\n"
                "  <h3>{{ doc.name }}</h3>\n"
                "  <p>Customer: {{ doc.customer_name }}</p>\n"
                "  <p>Date: {{ frappe.utils.formatdate(doc.posting_date) }}</p>\n"
                "  <table class='table table-bordered'>\n"
                "    <thead><tr>\n"
                "      <th>Item</th><th>Qty</th><th>Rate</th><th>Amount</th>\n"
                "    </tr></thead>\n"
                "    <tbody>\n"
                "    {% for item in doc.items %}\n"
                "      <tr>\n"
                "        <td>{{ item.item_name }}</td>\n"
                "        <td>{{ item.qty }}</td>\n"
                "        <td>{{ frappe.utils.fmt_money(item.rate) }}</td>\n"
                "        <td>{{ frappe.utils.fmt_money(item.amount) }}</td>\n"
                "      </tr>\n"
                "    {% endfor %}\n"
                "    </tbody>\n"
                "  </table>\n"
                "  <p><strong>Total: {{ frappe.utils.fmt_money(doc.grand_total) }}</strong></p>\n"
                "</div>\n\n"
                "TIPS:\n"
                "- Use Bootstrap classes for layout\n"
                "- Include @media print CSS for print-specific styling\n"
                "- Letter Head is auto-applied (configurable in Print Settings)\n"
                "- Test via: /printview?doctype=Sales%20Invoice&name=SI-001&format=Custom"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_print_format")


def index_permissions():
    """Index Frappe permission system."""
    knowledge = [
        {
            "title": "Frappe Permission System — Roles, DocPerm, User Permission",
            "content": (
                "Frappe Permission System:\n\n"
                "3 LAYERS:\n"
                "1. Role Permission (DocPerm): Role → DocType level\n"
                "2. User Permission: User → specific record level\n"
                "3. Permission Level (permlevel): Field-level access\n\n"
                "ROLE PERMISSION (DocPerm):\n"
                "- Set in DocType definition or via Role Permission Manager\n"
                "- Permissions: read, write, create, delete, submit, cancel, amend\n"
                "- Additional: report, import, export, print, email, share, set_user_permissions\n"
                "- apply_user_permissions: 1 = restrict to user's allowed records\n"
                "- if_owner: 1 = only own documents\n\n"
                "USER PERMISSION:\n"
                "DocType: User Permission\n"
                "- Restricts Link field values for a user\n"
                "- Example: User can only see Sales Orders for 'Company A'\n"
                "create_document(doctype='User Permission', values={\n"
                "  'user': 'user@example.com',\n"
                "  'allow': 'Company',\n"
                "  'for_value': 'My Company'\n"
                "})\n"
                "- is_default: 1 = auto-fill this value in new docs\n"
                "- applicable_for: Restrict to specific DocType only\n\n"
                "PERMISSION LEVEL (permlevel):\n"
                "- Fields have permlevel 0-9\n"
                "- Role must have permission for that level\n"
                "- Example: Salary details at permlevel 1 — only HR Manager can read/write\n\n"
                "SHARING:\n"
                "- frappe.share.add(doctype, name, user, read, write)\n"
                "- Adds one-off permission for specific user + document\n\n"
                "CHECK IN CODE:\n"
                "- frappe.has_permission(doctype, 'read', doc): Check permission\n"
                "- frappe.permissions.get_role_permissions(role, doctype): Get perms\n"
                "- frappe.only_for(['System Manager']): Restrict function to roles\n\n"
                "COMMON ROLES:\n"
                "- System Manager: Full access\n"
                "- Administrator: Super admin (cannot be restricted)\n"
                "- All: Everyone (including guests for website)\n"
                "- Guest: Unauthenticated users (website only)\n"
                "- Custom roles: Create via Role DocType"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_permissions")


def index_api_patterns():
    """Index Frappe API patterns — whitelisted methods, REST API."""
    knowledge = [
        {
            "title": "Frappe API — Whitelisted Methods & REST API",
            "content": (
                "Frappe API Patterns:\n\n"
                "WHITELISTED METHOD:\n"
                "@frappe.whitelist()\n"
                "def my_api(param1, param2=None):\n"
                "    '''Accessible via /api/method/app.module.file.my_api'''\n"
                "    return {'result': param1}\n\n"
                "@frappe.whitelist(allow_guest=True)\n"
                "def public_api():\n"
                "    '''No login required'''\n"
                "    pass\n\n"
                "CALLING FROM JS:\n"
                "frappe.call({\n"
                "  method: 'app.module.file.my_api',\n"
                "  args: { param1: 'value' },\n"
                "  callback: (r) => console.log(r.message)\n"
                "});\n\n"
                "REST API (built-in, no code needed):\n"
                "- GET /api/resource/DocType?filters=[[...]]&fields=[...]&limit=20\n"
                "- GET /api/resource/DocType/name\n"
                "- POST /api/resource/DocType (body = doc JSON)\n"
                "- PUT /api/resource/DocType/name (body = fields to update)\n"
                "- DELETE /api/resource/DocType/name\n\n"
                "AUTH:\n"
                "- Cookie-based (after /api/method/login)\n"
                "- Token: Authorization: token api_key:api_secret\n"
                "- Basic Auth: Authorization: Basic base64(api_key:api_secret)\n\n"
                "CONTROLLER METHODS:\n"
                "In DocType controller (my_doctype.py):\n"
                "class MyDoctype(Document):\n"
                "    def validate(self): pass      # Before save (every save)\n"
                "    def before_save(self): pass    # Just before DB write\n"
                "    def after_insert(self): pass   # After first save\n"
                "    def on_update(self): pass      # After every save\n"
                "    def on_submit(self): pass      # After submit\n"
                "    def on_cancel(self): pass      # After cancel\n"
                "    def before_delete(self): pass  # Before deletion\n"
                "    def on_trash(self): pass       # After deletion\n"
                "    def autoname(self): pass       # Custom naming logic\n\n"
                "RUNNING SQL:\n"
                "frappe.db.sql('SELECT name, customer_name FROM `tabCustomer` WHERE territory=%s',\n"
                "              ('Mumbai',), as_dict=True)\n"
                "# ALWAYS use parameterized queries to prevent SQL injection!"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_api_patterns")


def index_naming():
    """Index naming patterns in Frappe."""
    knowledge = [
        {
            "title": "Frappe Naming Rules — Document ID Patterns",
            "content": (
                "Naming Rules in Frappe — How document names/IDs are generated:\n\n"
                "1. NAMING SERIES (most common for transactional docs):\n"
                "   autoname = 'naming_series:'\n"
                "   Series field added to form. User selects prefix.\n"
                "   Pattern: PREFIX-.YYYY.-.#####\n"
                "   Example: SAL-ORD-2026-00001, ACC-JV-2026-00001\n"
                "   Customize: Naming Series tool (/app/naming-series)\n\n"
                "2. BY FIELDNAME:\n"
                "   autoname = 'field:customer_name'\n"
                "   Uses value of the field as document name.\n"
                "   Must be unique. Good for master data.\n"
                "   Example: Customer named by customer_name\n\n"
                "3. FORMAT STRING:\n"
                "   autoname = 'format:STU-{student_name}-{###}'\n"
                "   Mix of field values and counters.\n"
                "   {###} = 3-digit counter, {#####} = 5-digit\n"
                "   {field_name} = field value\n\n"
                "4. HASH:\n"
                "   autoname = 'hash'\n"
                "   Random 10-char hash. Good when name doesn't matter.\n\n"
                "5. AUTOINCREMENT:\n"
                "   autoname = 'autoincrement'\n"
                "   Simple 1, 2, 3... numbering.\n\n"
                "6. PROMPT (Set by User):\n"
                "   autoname = 'Prompt'\n"
                "   User enters the name manually.\n\n"
                "7. BY SCRIPT:\n"
                "   Define autoname(self) method in controller:\n"
                "   def autoname(self):\n"
                "       self.name = f'{self.branch}-{self.posting_date}-{frappe.utils.random_string(5)}'\n\n"
                "SPECIAL VARIABLES IN FORMAT:\n"
                "- {YYYY} = 4-digit year\n"
                "- {YY} = 2-digit year\n"
                "- {MM} = 2-digit month\n"
                "- {DD} = 2-digit day\n"
                "- {#} to {##########} = counter with N digits"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_naming")


def index_child_table():
    """Index child table patterns."""
    knowledge = [
        {
            "title": "Child Table DocType — Creation and Usage",
            "content": (
                "Child Table in Frappe — Table within a document:\n\n"
                "CREATING A CHILD TABLE:\n"
                "Step 1: Create child DocType with istable=1\n"
                "create_document(doctype='DocType', values={\n"
                "  'name': 'Student Subject',\n"
                "  'module': 'Custom',\n"
                "  'istable': 1,           # This makes it a child table\n"
                "  'fields': [\n"
                "    {'fieldname': 'subject', 'fieldtype': 'Data', 'label': 'Subject',\n"
                "     'in_list_view': 1, 'reqd': 1},\n"
                "    {'fieldname': 'marks', 'fieldtype': 'Int', 'label': 'Marks',\n"
                "     'in_list_view': 1},\n"
                "    {'fieldname': 'grade', 'fieldtype': 'Data', 'label': 'Grade',\n"
                "     'in_list_view': 1}\n"
                "  ]\n"
                "})\n\n"
                "Step 2: Add Table field in parent DocType\n"
                "Add field: {'fieldname': 'subjects', 'fieldtype': 'Table',\n"
                "  'options': 'Student Subject', 'label': 'Subjects'}\n\n"
                "AUTO-ADDED FIELDS (by Frappe):\n"
                "- parent: Link to parent document\n"
                "- parenttype: Parent DocType name\n"
                "- parentfield: Field name in parent\n"
                "- idx: Row index (1-based)\n"
                "- name: Unique hash ID\n\n"
                "ACCESSING IN PYTHON:\n"
                "doc = frappe.get_doc('Student', 'STU-001')\n"
                "for row in doc.subjects:     # Iterate child rows\n"
                "    print(row.subject, row.marks)\n\n"
                "# Add row\n"
                "doc.append('subjects', {'subject': 'Math', 'marks': 95})\n"
                "doc.save()\n\n"
                "# Remove rows\n"
                "doc.subjects = [r for r in doc.subjects if r.subject != 'Math']\n"
                "doc.save()\n\n"
                "ACCESSING IN CLIENT SCRIPT:\n"
                "// Add row\n"
                "let row = frm.add_child('subjects', {subject: 'Math', marks: 95});\n"
                "frm.refresh_field('subjects');\n\n"
                "// Read rows\n"
                "frm.doc.subjects.forEach(row => console.log(row.subject));\n\n"
                "// Remove all rows\n"
                "frm.clear_table('subjects');\n"
                "frm.refresh_field('subjects');\n\n"
                "IMPORTANT:\n"
                "- in_list_view=1 on fields you want visible in the table grid\n"
                "- Child table fields don't appear in global search\n"
                "- Child tables can have up to ~20 visible columns comfortably\n"
                "- Use reqd=1 for mandatory fields per row"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_child_table")


def index_report():
    """Index Report creation patterns."""
    knowledge = [
        {
            "title": "Reports — Script Report and Query Report",
            "content": (
                "Reports in Frappe:\n\n"
                "1. REPORT BUILDER (no code):\n"
                "   Auto-generated for every DocType\n"
                "   URL: /app/query-report/DocType\n"
                "   Users can add columns, filters, sort, group\n\n"
                "2. QUERY REPORT (SQL-based):\n"
                "create_document(doctype='Report', values={\n"
                "  'report_name': 'Monthly Sales Summary',\n"
                "  'ref_doctype': 'Sales Invoice',\n"
                "  'report_type': 'Query Report',\n"
                "  'query': '''\n"
                "    SELECT posting_date, customer, grand_total, status\n"
                "    FROM `tabSales Invoice`\n"
                "    WHERE posting_date BETWEEN %(from_date)s AND %(to_date)s\n"
                "    AND docstatus = 1\n"
                "    ORDER BY posting_date DESC\n"
                "  ''',\n"
                "  'is_standard': 'No'\n"
                "})\n\n"
                "3. SCRIPT REPORT (Python-based, most powerful):\n"
                "create_document(doctype='Report', values={\n"
                "  'report_name': 'Sales Analytics',\n"
                "  'ref_doctype': 'Sales Invoice',\n"
                "  'report_type': 'Script Report',\n"
                "  'is_standard': 'No',\n"
                "  'report_script': '''\n"
                "# Available variables: filters, frappe\n"
                "columns = [\n"
                "  {'fieldname': 'customer', 'label': 'Customer', 'fieldtype': 'Link',\n"
                "   'options': 'Customer', 'width': 200},\n"
                "  {'fieldname': 'total', 'label': 'Total Sales', 'fieldtype': 'Currency',\n"
                "   'width': 150},\n"
                "  {'fieldname': 'count', 'label': 'Invoice Count', 'fieldtype': 'Int',\n"
                "   'width': 100}\n"
                "]\n"
                "data = frappe.db.sql(\"\"\"\n"
                "  SELECT customer, SUM(grand_total) as total, COUNT(*) as count\n"
                "  FROM `tabSales Invoice`\n"
                "  WHERE docstatus=1\n"
                "  AND posting_date BETWEEN %(from_date)s AND %(to_date)s\n"
                "  GROUP BY customer\n"
                "  ORDER BY total DESC\n"
                "\"\"\", filters, as_dict=True)\n"
                "result = [columns, data]\n"
                "  '''\n"
                "})\n\n"
                "REPORT FILTERS:\n"
                "Defined in 'filters' JSON field:\n"
                "[\n"
                "  {'fieldname': 'from_date', 'fieldtype': 'Date', 'label': 'From Date',\n"
                "   'default': frappe.utils.add_months(frappe.utils.today(), -1), 'reqd': 1},\n"
                "  {'fieldname': 'to_date', 'fieldtype': 'Date', 'label': 'To Date',\n"
                "   'default': frappe.utils.today(), 'reqd': 1},\n"
                "  {'fieldname': 'customer', 'fieldtype': 'Link', 'options': 'Customer',\n"
                "   'label': 'Customer'}\n"
                "]\n\n"
                "ACCESS:\n"
                "URL: /app/query-report/Monthly Sales Summary"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_report")


def index_hooks():
    """Index hooks.py patterns."""
    knowledge = [
        {
            "title": "hooks.py — App Configuration and Event Hooks",
            "content": (
                "hooks.py — Central configuration file for Frappe apps:\n\n"
                "COMMON HOOKS:\n\n"
                "# App metadata\n"
                "app_name = 'my_app'\n"
                "app_title = 'My App'\n"
                "app_version = '1.0.0'\n\n"
                "# Include JS/CSS in every page\n"
                "app_include_js = '/assets/my_app/js/my_app.js'\n"
                "app_include_css = '/assets/my_app/css/my_app.css'\n\n"
                "# DocType-specific JS/CSS\n"
                "doctype_js = {'Sales Order': 'public/js/sales_order.js'}\n"
                "doctype_list_js = {'Sales Order': 'public/js/sales_order_list.js'}\n"
                "doctype_tree_js = {'Account': 'public/js/account_tree.js'}\n\n"
                "# Document events (like Server Script but in code)\n"
                "doc_events = {\n"
                "    'Sales Order': {\n"
                "        'validate': 'my_app.events.sales_order.validate',\n"
                "        'on_submit': 'my_app.events.sales_order.on_submit',\n"
                "        'before_save': 'my_app.events.sales_order.before_save',\n"
                "    },\n"
                "    '*': {  # All DocTypes\n"
                "        'on_update': 'my_app.events.common.on_update'\n"
                "    }\n"
                "}\n\n"
                "# Scheduler events\n"
                "scheduler_events = {\n"
                "    'daily': ['my_app.tasks.daily_task'],\n"
                "    'hourly': ['my_app.tasks.hourly_task'],\n"
                "    'weekly': ['my_app.tasks.weekly_task'],\n"
                "    'monthly': ['my_app.tasks.monthly_task'],\n"
                "    'cron': {\n"
                "        '0 9 * * *': ['my_app.tasks.nine_am_task'],  # 9 AM daily\n"
                "        '*/5 * * * *': ['my_app.tasks.every_5_min'],\n"
                "    }\n"
                "}\n\n"
                "# Override/extend existing DocType controllers\n"
                "override_doctype_class = {\n"
                "    'Sales Order': 'my_app.overrides.CustomSalesOrder'\n"
                "}\n\n"
                "# Fixtures (export DocType records with app)\n"
                "fixtures = [\n"
                "    'Custom Field',  # Export all\n"
                "    {'dt': 'Property Setter', 'filters': [['module', '=', 'My App']]},\n"
                "    {'dt': 'Client Script', 'filters': [['module', '=', 'My App']]},\n"
                "]\n\n"
                "# After install / before uninstall\n"
                "after_install = 'my_app.install.after_install'\n"
                "before_uninstall = 'my_app.uninstall.before_uninstall'\n\n"
                "# Jinja environment (custom filters/methods)\n"
                "jinja = {\n"
                "    'methods': ['my_app.utils.jinja_utils.my_method']\n"
                "}\n\n"
                "# Website routing\n"
                "website_route_rules = [\n"
                "    {'from_route': '/my-page/<path:name>', 'to_route': 'my_page'}\n"
                "]\n\n"
                "# Override whitelisted methods\n"
                "override_whitelisted_methods = {\n"
                "    'frappe.client.get_count': 'my_app.overrides.custom_get_count'\n"
                "}"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_hooks")


def index_jinja():
    """Index Jinja templating in Frappe."""
    knowledge = [
        {
            "title": "Jinja Templating in Frappe — Print Formats, Web Pages, Email",
            "content": (
                "Jinja Templating in Frappe:\n\n"
                "USED IN: Print Formats, Email Templates, Web Pages, Letter Head\n\n"
                "BASIC SYNTAX:\n"
                "{{ variable }}           — Output value\n"
                "{% if condition %}...{% endif %}  — Conditional\n"
                "{% for item in list %}...{% endfor %}  — Loop\n"
                "{# comment #}           — Comment\n\n"
                "AVAILABLE VARIABLES IN PRINT:\n"
                "- doc: Current document\n"
                "- doc.name, doc.customer, doc.items etc.\n"
                "- frappe: Full frappe module\n"
                "- frappe.utils: Utility functions\n"
                "- nowdate: Current date\n"
                "- letter_head: Letter Head HTML\n\n"
                "USEFUL FILTERS:\n"
                "{{ value|default('N/A') }}\n"
                "{{ value|round(2) }}\n"
                "{{ value|e }}              — HTML escape\n"
                "{{ date|frappe.format_date }}\n"
                "{{ amount|fmt_money }}\n\n"
                "COMMON PATTERNS:\n\n"
                "Table with items:\n"
                "<table class='table'>\n"
                "  <thead><tr><th>#</th><th>Item</th><th>Qty</th><th>Amount</th></tr></thead>\n"
                "  <tbody>\n"
                "  {% for row in doc.items %}\n"
                "    <tr>\n"
                "      <td>{{ row.idx }}</td>\n"
                "      <td>{{ row.item_name }}</td>\n"
                "      <td>{{ row.qty }}</td>\n"
                "      <td>{{ frappe.utils.fmt_money(row.amount, currency=doc.currency) }}</td>\n"
                "    </tr>\n"
                "  {% endfor %}\n"
                "  </tbody>\n"
                "</table>\n\n"
                "Conditional display:\n"
                "{% if doc.discount_amount > 0 %}\n"
                "  <p>Discount: {{ frappe.utils.fmt_money(doc.discount_amount) }}</p>\n"
                "{% endif %}\n\n"
                "Number to words:\n"
                "{{ frappe.utils.money_in_words(doc.grand_total, doc.currency) }}\n\n"
                "QR Code (v14+):\n"
                "{{ frappe.utils.get_url() }}/app/sales-invoice/{{ doc.name }}"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_jinja")


def index_best_practices():
    """Index Frappe development best practices."""
    knowledge = [
        {
            "title": "Frappe Development Best Practices",
            "content": (
                "Frappe Development Best Practices:\n\n"
                "NAMING CONVENTIONS:\n"
                "- DocType names: Title Case (Sales Order, Customer Payment)\n"
                "- fieldname: snake_case (customer_name, posting_date)\n"
                "- labels: Title Case (Customer Name, Posting Date)\n"
                "- Module names: Title Case (Selling, Accounts, HR)\n"
                "- Python files: snake_case (sales_order.py)\n"
                "- JS files: snake_case (sales_order.js)\n\n"
                "FIELD ORDERING:\n"
                "1. Name/Title fields first\n"
                "2. Key reference fields (customer, supplier)\n"
                "3. Date fields\n"
                "4. Status/workflow fields\n"
                "5. Section Break → Detail fields\n"
                "6. Table fields\n"
                "7. Section Break → Totals/Summary\n"
                "8. Section Break (collapsible) → Settings/Advanced\n"
                "9. Section Break (collapsible) → Notes/Comments\n\n"
                "MUST DO:\n"
                "- Always use parameterized SQL: frappe.db.sql('...%s', (value,))\n"
                "- NEVER concatenate user input into SQL strings\n"
                "- Use frappe.whitelist() for all API endpoints\n"
                "- Use frappe.has_permission() before sensitive operations\n"
                "- Use Password fieldtype for secrets (encrypted in DB)\n"
                "- Run bench migrate after DocType changes\n"
                "- Test on both v14 and v15 if targeting both\n\n"
                "AVOID:\n"
                "- Don't modify core DocType JSON files directly\n"
                "- Don't hardcode company/user names\n"
                "- Don't use frappe.db.sql for simple operations (use get_list/get_value)\n"
                "- Don't skip validation in before_save\n"
                "- Don't use synchronous HTTP calls in doc events\n"
                "- Don't store large data in Data fields (use Text/Long Text)\n\n"
                "PERFORMANCE:\n"
                "- Use limit_page_length in get_list\n"
                "- Index frequently filtered fields (add 'Index' in field properties)\n"
                "- Use frappe.cache() for expensive computations\n"
                "- Avoid N+1 queries in loops — use get_all with filters\n"
                "- Use background jobs for heavy processing: frappe.enqueue()\n\n"
                "v14 vs v15 COMPATIBILITY:\n"
                "- No match/case statements (Python 3.10+)\n"
                "- No walrus operator (:=)\n"
                "- frappe.cache().set_value(expires_in_sec=) works on both\n"
                "- Tab Break available in v14+ (but render differently)\n"
                "- Virtual DocType only in v15+"
            ),
        },
        {
            "title": "Common Frappe Errors and Fixes",
            "content": (
                "Common Frappe Development Errors:\n\n"
                "ERROR: 'DocType not found'\n"
                "FIX: Run bench migrate. DocType JSON exists but DB table not created.\n\n"
                "ERROR: 'ValidationError: Not permitted'\n"
                "FIX: Check permissions in DocType → Permission Rules. Add role permissions.\n\n"
                "ERROR: 'LinkValidationError'\n"
                "FIX: The Link field value doesn't exist. Check the linked DocType has that record.\n\n"
                "ERROR: 'MandatoryError: field required'\n"
                "FIX: Set the required field value or make it optional (reqd=0).\n\n"
                "ERROR: 'DuplicateEntryError'\n"
                "FIX: Document with same name exists. Check naming rule. Use unique fields properly.\n\n"
                "ERROR: 'ImportError: Module not found'\n"
                "FIX: bench --site <site> clear-cache && bench build. Check module in modules.txt.\n\n"
                "ERROR: 'PermissionError: Not allowed to access DocType'\n"
                "FIX: User's role doesn't have read permission. Add via Role Permission Manager.\n\n"
                "ERROR: Client Script not running\n"
                "FIX: 1. Check 'enabled' checkbox. 2. Clear cache. 3. Hard refresh browser.\n"
                "4. Check browser console for JS errors.\n\n"
                "ERROR: Custom Field not showing\n"
                "FIX: 1. bench migrate. 2. Clear cache. 3. Check insert_after points to valid field.\n\n"
                "ERROR: 'Cannot edit submitted document'\n"
                "FIX: Set allow_on_submit=1 on the field, or amend the document.\n\n"
                "ERROR: Workflow stuck\n"
                "FIX: Check workflow_state matches a valid state. Check transition conditions.\n"
                "Check user has the required role for the transition.\n\n"
                "DEBUGGING:\n"
                "- bench console: Interactive Python shell with frappe\n"
                "- frappe.logger().info('msg'): Write to logs\n"
                "- Browser → F12 → Console: Client-side errors\n"
                "- /api/method/frappe.client.get_list?doctype=Error Log: Check error logs\n"
                "- bench --site <site> set-config developer_mode 1: Enable developer mode"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_best_practices")


def index_fac_tool_formats():
    """Index exact FAC MCP tool parameter formats for Developer Mode."""
    knowledge = [
        {
            "title": "FAC Tool — create_document Exact Format",
            "content": (
                "FAC MCP Tool: create_document — EXACT parameter format:\n\n"
                "The create_document tool takes EXACTLY these parameters:\n"
                "  doctype: (string) The DocType name, e.g. 'Custom Field', 'Client Script', 'Property Setter'\n"
                "  data: (object) A JSON object with ALL the fields for the new document\n\n"
                "CORRECT Examples:\n\n"
                "1. Create Custom Field:\n"
                "   doctype: 'Custom Field'\n"
                "   data: {\n"
                '     "dt": "Sales Order",\n'
                '     "fieldname": "custom_delivery_notes",\n'
                '     "label": "Delivery Notes",\n'
                '     "fieldtype": "Small Text",\n'
                '     "insert_after": "delivery_date"\n'
                "   }\n\n"
                "2. Create Client Script:\n"
                "   doctype: 'Client Script'\n"
                "   data: {\n"
                '     "dt": "Sales Order",\n'
                '     "script_type": "Form",\n'
                '     "enabled": 1,\n'
                '     "script": "frappe.ui.form.on(\'Sales Order\', {refresh: function(frm) { console.log(\'loaded\'); }})"\n'
                "   }\n\n"
                "3. Create Property Setter:\n"
                "   doctype: 'Property Setter'\n"
                "   data: {\n"
                '     "doc_type": "Sales Order",\n'
                '     "field_name": "delivery_date",\n'
                '     "property": "reqd",\n'
                '     "property_type": "Check",\n'
                '     "value": "1",\n'
                '     "doctype_or_field": "DocField"\n'
                "   }\n\n"
                "4. Create Server Script:\n"
                "   doctype: 'Server Script'\n"
                "   data: {\n"
                '     "script_type": "DocEvent",\n'
                '     "reference_doctype": "Sales Order",\n'
                '     "doctype_event": "Before Save",\n'
                '     "script": "if doc.grand_total > 100000:\\n    frappe.throw(\'Amount exceeds limit\')",\n'
                '     "enabled": 1\n'
                "   }\n\n"
                "WRONG — DO NOT DO THIS:\n"
                "   doctype: 'Custom Field'\n"
                "   dt: 'Sales Order'  ← WRONG! dt must be INSIDE data object\n"
                "   fieldname: 'custom_x'  ← WRONG! must be INSIDE data object\n\n"
                "RULE: ALL document fields go inside the 'data' parameter. "
                "Only 'doctype' is a top-level parameter."
            ),
        },
        {
            "title": "FAC Tool — update_document Exact Format",
            "content": (
                "FAC MCP Tool: update_document — EXACT parameter format:\n\n"
                "Parameters:\n"
                "  doctype: (string) The DocType name\n"
                "  name: (string) The document name/ID to update\n"
                "  data: (object) Fields to update (only changed fields needed)\n\n"
                "Example — Update Custom Field:\n"
                "   doctype: 'Custom Field'\n"
                "   name: 'Sales Order-custom_delivery_notes'\n"
                "   data: {\"label\": \"Delivery Instructions\", \"reqd\": 1}\n\n"
                "Example — Update Client Script:\n"
                "   doctype: 'Client Script'\n"
                "   name: 'CS-00001'\n"
                "   data: {\"enabled\": 0}\n\n"
                "RULE: 'data' contains ONLY the fields you want to change."
            ),
        },
        {
            "title": "FAC Tool — list_documents and get_document Format",
            "content": (
                "FAC MCP Tool: list_documents — parameters:\n"
                "  doctype: (string) DocType to list\n"
                "  filters: (object, optional) e.g. {\"dt\": \"Sales Order\"}\n"
                "  fields: (array, optional) e.g. [\"name\", \"fieldname\", \"label\"]\n"
                "  limit_page_length: (number, optional) default 20\n"
                "  order_by: (string, optional) e.g. \"creation desc\"\n\n"
                "FAC MCP Tool: get_document — parameters:\n"
                "  doctype: (string) DocType name\n"
                "  name: (string) Document name/ID\n\n"
                "Example — List all Custom Fields on Sales Order:\n"
                "   doctype: 'Custom Field'\n"
                "   filters: {\"dt\": \"Sales Order\"}\n"
                "   fields: [\"name\", \"fieldname\", \"label\", \"fieldtype\"]\n\n"
                "Example — Get a specific DocType definition:\n"
                "   doctype: 'DocType'\n"
                "   name: 'Sales Order'"
            ),
        },
        {
            "title": "Developer Mode — No-Code Workflow Rules",
            "content": (
                "Developer Mode — When to use which approach:\n\n"
                "NO-CODE (use existing tools, instant, no bench migrate):\n"
                "- Add field to existing DocType → create_document with doctype='Custom Field'\n"
                "- Change field property → create_document with doctype='Property Setter'\n"
                "- Add form logic → create_document with doctype='Client Script'\n"
                "- Add server validation → create_document with doctype='Server Script'\n"
                "- Add workflow → create_document with doctype='Workflow'\n"
                "- Add print format → create_document with doctype='Print Format'\n\n"
                "REQUIRES BENCH MIGRATE (only when absolutely necessary):\n"
                "- Create entirely new DocType → needs bench migrate after creation\n"
                "- This is rare — most customization is no-code\n\n"
                "ALWAYS CHECK FIRST:\n"
                "- Before adding Custom Field: list existing fields with list_documents\n"
                "- Before creating Client Script: check if one already exists for that DocType\n"
                "- Use get_document to inspect DocType schema before modifying\n\n"
                "NAMING CONVENTIONS:\n"
                "- Custom Field name: '{DocType}-{fieldname}' e.g. 'Sales Order-custom_delivery_notes'\n"
                "- Custom fieldnames MUST start with 'custom_'\n"
                "- Client Script names are auto-generated (CS-00001, CS-00002)\n"
                "- Property Setter names are auto-generated"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_fac_tool_formats")


def index_dev_dashboard():
    """Index dev dashboard knowledge — how to show all customizations."""
    knowledge = [
        {
            "title": "Dev Dashboard — Show All Customizations on a DocType",
            "content": (
                "When user asks 'show customizations on Sales Order' or 'dev dashboard for Customer':\n\n"
                "Use run_database_query with this SINGLE SQL query (replace 'Sales Order' with the DocType):\n\n"
                "SELECT 'Custom Field' as type, fieldname as name, CONCAT(label, ' (', fieldtype, ')') as detail, "
                "insert_after as extra FROM `tabCustom Field` WHERE dt='Sales Order'\n"
                "UNION ALL\n"
                "SELECT 'Property Setter' as type, field_name as name, CONCAT(property, ' = ', value) as detail, "
                "doctype_or_field as extra FROM `tabProperty Setter` WHERE doc_type='Sales Order'\n"
                "UNION ALL\n"
                "SELECT 'Client Script' as type, name, CONCAT(script_type, IF(enabled, ' ✅', ' ❌')) as detail, "
                "'' as extra FROM `tabClient Script` WHERE dt='Sales Order'\n"
                "UNION ALL\n"
                "SELECT 'Server Script' as type, name, CONCAT(script_type, ' - ', doctype_event, IF(enabled, ' ✅', ' ❌')) as detail, "
                "'' as extra FROM `tabServer Script` WHERE reference_doctype='Sales Order'\n"
                "UNION ALL\n"
                "SELECT 'Workflow' as type, name, IF(is_active, 'Active ✅', 'Inactive ❌') as detail, "
                "'' as extra FROM `tabWorkflow` WHERE document_type='Sales Order'\n\n"
                "This returns ALL customizations in ONE query. Group results by 'type' column.\n\n"
                "Present as:\n"
                "## Customizations on Sales Order\n"
                "### Custom Fields (count)\n"
                "- fieldname (Type) after position\n"
                "### Property Setters (count)\n"
                "- field: property = value\n"
                "### Client Scripts (count)\n"
                "- name (type, enabled/disabled)\n"
                "### Server Scripts / Workflows\n"
                "- or 'None' if empty\n\n"
                "IMPORTANT: Use run_database_query tool, NOT multiple list_documents calls. One query is faster and more reliable."
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_dashboard")


def index_phase_a_recipes():
    """Index Phase A recipes — field & DocType operations with exact tool calls."""
    knowledge = [
        {
            "title": "Recipe: Create Child Table and Add to Parent DocType",
            "content": (
                "Recipe: Add a child table to an existing DocType\n\n"
                "Example: 'Sales Order mein Payment Schedule child table add karo with date, amount, status'\n\n"
                "STEP 1 — Create the child DocType (istable=1):\n"
                "create_document(doctype='DocType', data={\n"
                "  'name': 'Payment Schedule Custom',\n"
                "  'module': 'Custom',\n"
                "  'istable': 1,\n"
                "  'editable_grid': 1,\n"
                "  'fields': [\n"
                "    {'fieldname': 'payment_date', 'fieldtype': 'Date', 'label': 'Payment Date',\n"
                "     'in_list_view': 1, 'reqd': 1, 'columns': 3},\n"
                "    {'fieldname': 'amount', 'fieldtype': 'Currency', 'label': 'Amount',\n"
                "     'in_list_view': 1, 'reqd': 1, 'columns': 3},\n"
                "    {'fieldname': 'status', 'fieldtype': 'Select', 'label': 'Status',\n"
                "     'options': 'Pending\\nPaid\\nOverdue', 'default': 'Pending',\n"
                "     'in_list_view': 1, 'columns': 2}\n"
                "  ],\n"
                "  'permissions': [{'role': 'System Manager', 'read': 1, 'write': 1, 'create': 1, 'delete': 1}]\n"
                "})\n\n"
                "STEP 2 — Add Table field to parent via Custom Field:\n"
                "create_document(doctype='Custom Field', data={\n"
                "  'dt': 'Sales Order',\n"
                "  'fieldname': 'custom_payment_schedule',\n"
                "  'fieldtype': 'Table',\n"
                "  'options': 'Payment Schedule Custom',\n"
                "  'label': 'Payment Schedule',\n"
                "  'insert_after': 'payment_terms_template'\n"
                "})\n\n"
                "STEP 3 — Tell user: 'bench migrate' needed (new DocType created DB table).\n\n"
                "NOTE: Child DocType needs bench migrate. Custom Field does NOT."
            ),
        },
        {
            "title": "Recipe: Create Custom DocType with Fields and Permissions",
            "content": (
                "Recipe: Create a brand new DocType\n\n"
                "Example: 'Vehicle Tracking DocType banao with vehicle_no, driver, location, status'\n\n"
                "create_document(doctype='DocType', data={\n"
                "  'name': 'Vehicle Tracking',\n"
                "  'module': 'Custom',\n"
                "  'naming_rule': 'By Naming Series',\n"
                "  'autoname': 'VT-.YYYY.-.#####',\n"
                "  'is_submittable': 0,\n"
                "  'quick_entry': 0,\n"
                "  'track_changes': 1,\n"
                "  'title_field': 'vehicle_no',\n"
                "  'search_fields': 'vehicle_no, driver_name',\n"
                "  'fields': [\n"
                "    {'fieldname': 'vehicle_no', 'fieldtype': 'Data', 'label': 'Vehicle Number',\n"
                "     'reqd': 1, 'in_list_view': 1, 'unique': 1},\n"
                "    {'fieldname': 'column_break_1', 'fieldtype': 'Column Break'},\n"
                "    {'fieldname': 'driver_name', 'fieldtype': 'Data', 'label': 'Driver Name',\n"
                "     'in_list_view': 1},\n"
                "    {'fieldname': 'details_section', 'fieldtype': 'Section Break', 'label': 'Details'},\n"
                "    {'fieldname': 'current_location', 'fieldtype': 'Data', 'label': 'Current Location'},\n"
                "    {'fieldname': 'column_break_2', 'fieldtype': 'Column Break'},\n"
                "    {'fieldname': 'status', 'fieldtype': 'Select', 'label': 'Status',\n"
                "     'options': 'Available\\nOn Trip\\nMaintenance\\nRetired',\n"
                "     'default': 'Available', 'in_list_view': 1},\n"
                "    {'fieldname': 'notes_section', 'fieldtype': 'Section Break', 'label': 'Notes',\n"
                "     'collapsible': 1},\n"
                "    {'fieldname': 'notes', 'fieldtype': 'Text Editor', 'label': 'Notes'}\n"
                "  ],\n"
                "  'permissions': [\n"
                "    {'role': 'System Manager', 'read': 1, 'write': 1, 'create': 1, 'delete': 1, 'submit': 0},\n"
                "    {'role': 'All', 'read': 1, 'write': 0}\n"
                "  ]\n"
                "})\n\n"
                "AFTER: User MUST run 'bench migrate' to create the DB table.\n"
                "Then access at: /app/vehicle-tracking"
            ),
        },
        {
            "title": "Recipe: Field Visibility, Dependency, Read-only, and Fetch",
            "content": (
                "Recipes for field behavior modifications:\n\n"
                "A5 — CONDITIONAL VISIBILITY (depends_on):\n"
                "'PAN field sirf India select karne pe dikhe'\n"
                "create_document(doctype='Property Setter', data={\n"
                "  'doc_type': 'Customer', 'field_name': 'custom_pan_number',\n"
                "  'property': 'depends_on', 'property_type': 'Text',\n"
                "  'value': 'eval:doc.country==\"India\"', 'doctype_or_field': 'DocField'\n"
                "})\n\n"
                "A6 — REORDER FIELDS (insert_after):\n"
                "'Email field ko phone ke baad rakh do'\n"
                "→ Custom Fields have insert_after property.\n"
                "→ For existing fields, use Property Setter with property='insert_after' (limited support).\n"
                "→ Better: Recreate as Custom Field in desired position.\n\n"
                "A7 — LINK FIELD WITH FILTERS (Client Script set_query):\n"
                "'Sales Order mein Customer field mein sirf Active customers dikhe'\n"
                "create_document(doctype='Client Script', data={\n"
                "  'dt': 'Sales Order', 'script_type': 'Form', 'enabled': 1,\n"
                "  'script': \"frappe.ui.form.on('Sales Order', {\\n\"\n"
                "    \"  setup(frm) {\\n\"\n"
                "    \"    frm.set_query('customer', () => {\\n\"\n"
                "    \"      return { filters: { disabled: 0 } };\\n\"\n"
                "    \"    });\\n\"\n"
                "    \"  }\\n\"\n"
                "    \"});\"\n"
                "})\n\n"
                "A8 — DEFAULT VALUES:\n"
                "'New Sales Order mein delivery date auto +7 days ho'\n"
                "Option 1 — Property Setter (static default):\n"
                "create_document(doctype='Property Setter', data={\n"
                "  'doc_type': 'Sales Order', 'field_name': 'delivery_date',\n"
                "  'property': 'default', 'property_type': 'Text',\n"
                "  'value': 'Today', 'doctype_or_field': 'DocField'\n"
                "})\n"
                "Option 2 — Client Script (dynamic default):\n"
                "create_document(doctype='Client Script', data={\n"
                "  'dt': 'Sales Order', 'script_type': 'Form', 'enabled': 1,\n"
                "  'script': \"frappe.ui.form.on('Sales Order', {\\n\"\n"
                "    \"  onload(frm) {\\n\"\n"
                "    \"    if (frm.is_new() && !frm.doc.delivery_date) {\\n\"\n"
                "    \"      frm.set_value('delivery_date', frappe.datetime.add_days(frappe.datetime.nowdate(), 7));\\n\"\n"
                "    \"    }\\n\"\n"
                "    \"  }\\n\"\n"
                "    \"});\"\n"
                "})\n\n"
                "A9 — READ-ONLY CONDITIONS:\n"
                "'Submitted SO mein delivery date change nahi ho sake'\n"
                "create_document(doctype='Property Setter', data={\n"
                "  'doc_type': 'Sales Order', 'field_name': 'delivery_date',\n"
                "  'property': 'read_only_depends_on', 'property_type': 'Text',\n"
                "  'value': 'eval:doc.docstatus==1', 'doctype_or_field': 'DocField'\n"
                "})\n\n"
                "A10 — FETCH FROM LINKED DOCUMENT:\n"
                "'Customer select kare toh phone auto-fill ho'\n"
                "create_document(doctype='Custom Field', data={\n"
                "  'dt': 'Sales Order', 'fieldname': 'custom_customer_phone',\n"
                "  'fieldtype': 'Data', 'label': 'Customer Phone',\n"
                "  'insert_after': 'customer_name', 'read_only': 1,\n"
                "  'fetch_from': 'customer.mobile_no', 'fetch_if_empty': 1\n"
                "})\n\n"
                "KEY RULES:\n"
                "- depends_on uses 'eval:' prefix for JS expressions\n"
                "- fetch_from format: 'link_fieldname.target_fieldname'\n"
                "- read_only_depends_on uses same 'eval:' syntax\n"
                "- mandatory_depends_on makes field required conditionally\n"
                "- For Property Setter: value is ALWAYS a string"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_phase_a_recipes")


def index_phase_b_recipes():
    """Index Phase B recipes — Client Script form behavior patterns."""
    knowledge = [
        {
            "title": "Recipe: Field Validation — Phone Number, Email, Custom Rules",
            "content": (
                "Recipe: Client Script field validation patterns\n\n"
                "B2 — PHONE NUMBER VALIDATION (10 digits):\n"
                "'Phone number 10 digit hona chahiye'\n"
                "create_document(doctype='Client Script', data={\n"
                "  'dt': 'Customer', 'script_type': 'Form', 'enabled': 1,\n"
                "  'script': \"frappe.ui.form.on('Customer', {\\n\"\n"
                "    \"  validate(frm) {\\n\"\n"
                "    \"    if (frm.doc.mobile_no && frm.doc.mobile_no.replace(/[^0-9]/g, '').length !== 10) {\\n\"\n"
                "    \"      frappe.msgprint({title: 'Validation Error', message: 'Mobile number must be exactly 10 digits.', indicator: 'red'});\\n\"\n"
                "    \"      frappe.validated = false;\\n\"\n"
                "    \"    }\\n\"\n"
                "    \"  }\\n\"\n"
                "    \"});\"\n"
                "})\n\n"
                "GENERIC VALIDATION PATTERN:\n"
                "frappe.ui.form.on('DocType', {\n"
                "  validate(frm) {\n"
                "    // Check condition\n"
                "    if (BAD_CONDITION) {\n"
                "      frappe.msgprint({title: 'Error', message: 'What went wrong', indicator: 'red'});\n"
                "      frappe.validated = false;  // PREVENTS SAVE\n"
                "    }\n"
                "  }\n"
                "});\n\n"
                "IMPORTANT: Set `frappe.validated = false` to PREVENT save. Without this, msgprint shows but save continues.\n\n"
                "EMAIL VALIDATION:\n"
                "if (frm.doc.email && !frm.doc.email.match(/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/)) {\n"
                "  frappe.msgprint('Invalid email format');\n"
                "  frappe.validated = false;\n"
                "}\n\n"
                "AMOUNT VALIDATION:\n"
                "if (frm.doc.grand_total > 1000000) {\n"
                "  frappe.msgprint('Amount exceeds 10 Lakh limit. Please get manager approval.');\n"
                "  frappe.validated = false;\n"
                "}"
            ),
        },
        {
            "title": "Recipe: Auto-Calculate Fields and Dynamic Mandatory",
            "content": (
                "Recipe: Auto-calculation and dynamic mandatory patterns\n\n"
                "B3 — AUTO-CALCULATE (total = qty × rate):\n"
                "'Total auto calculate ho qty × rate se'\n"
                "create_document(doctype='Client Script', data={\n"
                "  'dt': 'Quotation', 'script_type': 'Form', 'enabled': 1,\n"
                "  'script': \"frappe.ui.form.on('Quotation', {\\n\"\n"
                "    \"  custom_qty(frm) { calculate_total(frm); },\\n\"\n"
                "    \"  custom_rate(frm) { calculate_total(frm); }\\n\"\n"
                "    \"});\\n\"\n"
                "    \"function calculate_total(frm) {\\n\"\n"
                "    \"  let total = (frm.doc.custom_qty || 0) * (frm.doc.custom_rate || 0);\\n\"\n"
                "    \"  frm.set_value('custom_total', total);\\n\"\n"
                "    \"}\"\n"
                "})\n\n"
                "CHILD TABLE AUTO-SUM:\n"
                "frappe.ui.form.on('Sales Order Item', {\n"
                "  qty(frm, cdt, cdn) {\n"
                "    let total = 0;\n"
                "    frm.doc.items.forEach(row => { total += row.amount || 0; });\n"
                "    frm.set_value('custom_items_total', total);\n"
                "  }\n"
                "});\n\n"
                "B6 — DYNAMIC MANDATORY:\n"
                "'Agar amount > 50000 toh approval_reason mandatory'\n"
                "create_document(doctype='Client Script', data={\n"
                "  'dt': 'Purchase Order', 'script_type': 'Form', 'enabled': 1,\n"
                "  'script': \"frappe.ui.form.on('Purchase Order', {\\n\"\n"
                "    \"  grand_total(frm) {\\n\"\n"
                "    \"    frm.toggle_reqd('custom_approval_reason', frm.doc.grand_total > 50000);\\n\"\n"
                "    \"  },\\n\"\n"
                "    \"  refresh(frm) {\\n\"\n"
                "    \"    frm.toggle_reqd('custom_approval_reason', frm.doc.grand_total > 50000);\\n\"\n"
                "    \"  }\\n\"\n"
                "    \"});\"\n"
                "})\n\n"
                "HIDE/SHOW FIELDS DYNAMICALLY:\n"
                "B1 — 'Agar order type Maintenance ho toh warranty field dikhe'\n"
                "frappe.ui.form.on('Sales Order', {\n"
                "  order_type(frm) {\n"
                "    frm.toggle_display('custom_warranty_period', frm.doc.order_type === 'Maintenance');\n"
                "  },\n"
                "  refresh(frm) {\n"
                "    frm.toggle_display('custom_warranty_period', frm.doc.order_type === 'Maintenance');\n"
                "  }\n"
                "});\n\n"
                "KEY METHODS:\n"
                "- frm.toggle_display(fieldname, show): Show/hide\n"
                "- frm.toggle_reqd(fieldname, reqd): Toggle mandatory\n"
                "- frm.toggle_enable(fieldname, enable): Toggle editable\n"
                "- frm.set_df_property(fieldname, 'hidden', 1): Direct property set"
            ),
        },
        {
            "title": "Recipe: Custom Buttons, Confirm Before Submit, Color Coding",
            "content": (
                "Recipe: Advanced Client Script patterns\n\n"
                "B8 — CUSTOM BUTTONS:\n"
                "'Sales Order mein Send WhatsApp button add karo'\n"
                "create_document(doctype='Client Script', data={\n"
                "  'dt': 'Sales Order', 'script_type': 'Form', 'enabled': 1,\n"
                "  'script': \"frappe.ui.form.on('Sales Order', {\\n\"\n"
                "    \"  refresh(frm) {\\n\"\n"
                "    \"    if (!frm.is_new()) {\\n\"\n"
                "    \"      frm.add_custom_button('Send WhatsApp', () => {\\n\"\n"
                "    \"        frappe.msgprint('WhatsApp message sent to ' + frm.doc.customer_name);\\n\"\n"
                "    \"      }, 'Actions');\\n\"\n"
                "    \"    }\\n\"\n"
                "    \"    if (frm.doc.docstatus === 1) {\\n\"\n"
                "    \"      frm.add_custom_button('Create Invoice', () => {\\n\"\n"
                "    \"        frappe.model.open_mapped_doc({\\n\"\n"
                "    \"          method: 'erpnext.selling.doctype.sales_order.sales_order.make_sales_invoice',\\n\"\n"
                "    \"          frm: frm\\n\"\n"
                "    \"        });\\n\"\n"
                "    \"      }, 'Create');\\n\"\n"
                "    \"    }\\n\"\n"
                "    \"  }\\n\"\n"
                "    \"});\"\n"
                "})\n\n"
                "B5 — CONFIRM BEFORE SUBMIT:\n"
                "'Submit karne se pehle confirm kare'\n"
                "create_document(doctype='Client Script', data={\n"
                "  'dt': 'Sales Order', 'script_type': 'Form', 'enabled': 1,\n"
                "  'script': \"frappe.ui.form.on('Sales Order', {\\n\"\n"
                "    \"  before_submit(frm) {\\n\"\n"
                "    \"    frappe.validated = false;\\n\"\n"
                "    \"    frappe.confirm(\\n\"\n"
                "    \"      'Are you sure you want to submit this Sales Order for ' + frm.doc.customer + '?',\\n\"\n"
                "    \"      () => {\\n\"\n"
                "    \"        frappe.validated = true;\\n\"\n"
                "    \"        frm.save('Submit');\\n\"\n"
                "    \"      }\\n\"\n"
                "    \"    );\\n\"\n"
                "    \"  }\\n\"\n"
                "    \"});\"\n"
                "})\n\n"
                "B7 — COLOR CODING / INDICATORS:\n"
                "'Overdue invoices ka status red dikhe'\n"
                "create_document(doctype='Client Script', data={\n"
                "  'dt': 'Sales Invoice', 'script_type': 'Form', 'enabled': 1,\n"
                "  'script': \"frappe.ui.form.on('Sales Invoice', {\\n\"\n"
                "    \"  refresh(frm) {\\n\"\n"
                "    \"    if (frm.doc.status === 'Overdue') {\\n\"\n"
                "    \"      frm.dashboard.set_headline(\\n\"\n"
                "    \"        '<span style=\\\\\"color:red;font-weight:bold\\\\\">⚠️ This invoice is OVERDUE!</span>'\\n\"\n"
                "    \"      );\\n\"\n"
                "    \"    }\\n\"\n"
                "    \"    if (frm.doc.grand_total > 100000) {\\n\"\n"
                "    \"      frm.set_intro('High value order — requires manager approval', 'yellow');\\n\"\n"
                "    \"    }\\n\"\n"
                "    \"  }\\n\"\n"
                "    \"});\"\n"
                "})\n\n"
                "B10 — DASHBOARD CONNECTIONS (show linked docs):\n"
                "frappe.ui.form.on('Sales Order', {\n"
                "  refresh(frm) {\n"
                "    frm.dashboard.add_transactions([{\n"
                "      label: 'Fulfillment',\n"
                "      items: ['Delivery Note', 'Sales Invoice', 'Payment Entry']\n"
                "    }]);\n"
                "  }\n"
                "});\n\n"
                "NOTE: Dashboard connections are usually defined in the DocType controller, "
                "but can be added via Client Script for custom links."
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_phase_b_recipes")


def index_phase_c_recipes():
    """Index Phase C recipes — Server Script backend logic patterns."""
    knowledge = [
        {
            "title": "Recipe: Server Script — Before Save Validation and Auto-Calculate",
            "content": (
                "Recipe: Server Script backend validation and calculation\n\n"
                "CRITICAL: Server Script 'name' is set by user — you MUST include '__newname' in data!\n\n"
                "C1 — BEFORE SAVE VALIDATION:\n"
                "'Sales Order save nahi ho agar grand_total < 100'\n"
                "create_document(doctype='Server Script', data={\n"
                "  '__newname': 'so_min_amount_check',\n"
                "  'script_type': 'DocType Event',\n"
                "  'reference_doctype': 'Sales Order',\n"
                "  'doctype_event': 'Before Save',\n"
                "  'enabled': 1,\n"
                "  'script': 'if doc.grand_total and doc.grand_total < 100:\\n'\n"
                "    '    frappe.throw(\"Sales Order amount must be at least 100\")'\n"
                "})\n\n"
                "C7 — AUTO-CALCULATE ON SERVER SIDE:\n"
                "'Invoice save pe GST 18% auto-calculate ho'\n"
                "create_document(doctype='Server Script', data={\n"
                "  '__newname': 'si_gst_auto_calc',\n"
                "  'script_type': 'DocType Event',\n"
                "  'reference_doctype': 'Sales Invoice',\n"
                "  'doctype_event': 'Before Save',\n"
                "  'enabled': 1,\n"
                "  'script': 'if doc.net_total:\\n'\n"
                "    '    doc.custom_gst_amount = doc.net_total * 0.18\\n'\n"
                "    '    doc.custom_total_with_gst = doc.net_total + doc.custom_gst_amount'\n"
                "})\n\n"
                "C3 — BEFORE SUBMIT CHECK:\n"
                "'Submit nahi ho agar items table empty hai'\n"
                "create_document(doctype='Server Script', data={\n"
                "  '__newname': 'so_require_items_before_submit',\n"
                "  'script_type': 'DocType Event',\n"
                "  'reference_doctype': 'Sales Order',\n"
                "  'doctype_event': 'Before Submit',\n"
                "  'enabled': 1,\n"
                "  'script': 'if not doc.items:\\n'\n"
                "    '    frappe.throw(\"Cannot submit Sales Order without items\")'\n"
                "})\n\n"
                "C10 — CONDITIONAL CANCEL:\n"
                "'Invoice cancel nahi ho agar Payment Entry linked hai'\n"
                "create_document(doctype='Server Script', data={\n"
                "  '__newname': 'si_prevent_cancel_with_payment',\n"
                "  'script_type': 'DocType Event',\n"
                "  'reference_doctype': 'Sales Invoice',\n"
                "  'doctype_event': 'Before Cancel',\n"
                "  'enabled': 1,\n"
                "  'script': 'payments = frappe.get_all(\"Payment Entry Reference\",\\n'\n"
                "    '    filters={\"reference_doctype\": \"Sales Invoice\", \"reference_name\": doc.name},\\n'\n"
                "    '    limit=1)\\n'\n"
                "    'if payments:\\n'\n"
                "    '    frappe.throw(\"Cannot cancel: Payment Entry linked to this invoice\")'\n"
                "})\n\n"
                "IMPORTANT RULES:\n"
                "- Server Script 'name' is SET BY USER — MUST include '__newname' in data!\n"
                "- Without '__newname', creation WILL FAIL with 'name required' error.\n"
                "- Use descriptive snake_case names: 'so_min_amount_check', 'daily_cleanup_task'\n"
                "- frappe.throw() stops the operation and shows error\n"
                "- doc.field_name to access current document fields\n"
                "- doc.items to access child table rows\n"
                "- Server Scripts run EVERY time (not just manual save — also API/imports)\n"
                "- Before Save runs on EVERY save (create + update)"
            ),
        },
        {
            "title": "Recipe: Server Script — After Submit Auto-Create and Cross-Doc Update",
            "content": (
                "Recipe: Server Script auto-create and cross-document operations\n\n"
                "C2 — AFTER SUBMIT AUTO-CREATE:\n"
                "'SO submit pe auto Delivery Note ban jaye'\n"
                "create_document(doctype='Server Script', data={\n"
                "  '__newname': 'so_auto_create_dn',\n"
                "  'script_type': 'DocType Event',\n"
                "  'reference_doctype': 'Sales Order',\n"
                "  'doctype_event': 'After Submit',\n"
                "  'enabled': 1,\n"
                "  'script': 'dn = frappe.new_doc(\"Delivery Note\")\\n'\n"
                "    'dn.customer = doc.customer\\n'\n"
                "    'dn.company = doc.company\\n'\n"
                "    'for item in doc.items:\\n'\n"
                "    '    dn.append(\"items\", {\\n'\n"
                "    '        \"item_code\": item.item_code,\\n'\n"
                "    '        \"qty\": item.qty,\\n'\n"
                "    '        \"rate\": item.rate,\\n'\n"
                "    '        \"against_sales_order\": doc.name,\\n'\n"
                "    '        \"so_detail\": item.name\\n'\n"
                "    '    })\\n'\n"
                "    'dn.insert()\\n'\n"
                "    'frappe.msgprint(f\"Delivery Note {dn.name} created automatically\")'\n"
                "})\n\n"
                "C6 — AUTO-ASSIGN (Round Robin):\n"
                "'New Lead auto-assign ho sales team ko'\n"
                "create_document(doctype='Server Script', data={\n"
                "  '__newname': 'lead_auto_assign_round_robin',\n"
                "  'script_type': 'DocType Event',\n"
                "  'reference_doctype': 'Lead',\n"
                "  'doctype_event': 'After Insert',\n"
                "  'enabled': 1,\n"
                "  'script': 'sales_team = [\"user1@example.com\", \"user2@example.com\", \"user3@example.com\"]\\n'\n"
                "    'lead_count = frappe.db.count(\"Lead\")\\n'\n"
                "    'assigned_to = sales_team[lead_count % len(sales_team)]\\n'\n"
                "    'frappe.desk.form.assign_to.add({\\n'\n"
                "    '    \"assign_to\": [assigned_to],\\n'\n"
                "    '    \"doctype\": \"Lead\",\\n'\n"
                "    '    \"name\": doc.name\\n'\n"
                "    '})'\n"
                "})\n\n"
                "C8 — CROSS-DOCUMENT UPDATE:\n"
                "'Payment Entry save pe Customer outstanding update ho'\n"
                "create_document(doctype='Server Script', data={\n"
                "  '__newname': 'pe_update_customer_outstanding',\n"
                "  'script_type': 'DocType Event',\n"
                "  'reference_doctype': 'Payment Entry',\n"
                "  'doctype_event': 'After Submit',\n"
                "  'enabled': 1,\n"
                "  'script': 'if doc.party_type == \"Customer\":\\n'\n"
                "    '    outstanding = frappe.db.sql(\\n'\n"
                "    '        \"\"\"SELECT SUM(outstanding_amount) FROM `tabSales Invoice`\\n'\n"
                "    '        WHERE customer=%s AND docstatus=1\"\"\",\\n'\n"
                "    '        doc.party)[0][0] or 0\\n'\n"
                "    '    frappe.db.set_value(\"Customer\", doc.party, \"custom_outstanding\", outstanding)'\n"
                "})\n\n"
                "C9 — TASK COMPLETION → PROJECT UPDATE:\n"
                "create_document(doctype='Server Script', data={\n"
                "  '__newname': 'task_update_project_progress',\n"
                "  'script_type': 'DocType Event',\n"
                "  'reference_doctype': 'Task',\n"
                "  'doctype_event': 'After Save',\n"
                "  'enabled': 1,\n"
                "  'script': 'if doc.project and doc.status == \"Completed\":\\n'\n"
                "    '    total = frappe.db.count(\"Task\", {\"project\": doc.project})\\n'\n"
                "    '    done = frappe.db.count(\"Task\", {\"project\": doc.project, \"status\": \"Completed\"})\\n'\n"
                "    '    pct = int((done / total) * 100) if total else 0\\n'\n"
                "    '    frappe.db.set_value(\"Project\", doc.project, \"percent_complete\", pct)'\n"
                "})"
            ),
        },
        {
            "title": "Recipe: Server Script — API Endpoint, Scheduled Task, Email",
            "content": (
                "Recipe: Server Script API, Cron, and Email patterns\n\n"
                "C5 — API ENDPOINT:\n"
                "'Ek API banao jo customer ka outstanding return kare'\n"
                "create_document(doctype='Server Script', data={\n"
                "  '__newname': 'get_customer_outstanding',\n"
                "  'script_type': 'API',\n"
                "  'api_method': 'get_customer_outstanding',\n"
                "  'allow_guest': 0,\n"
                "  'enabled': 1,\n"
                "  'script': 'customer = frappe.form_dict.get(\"customer\")\\n'\n"
                "    'if not customer:\\n'\n"
                "    '    frappe.throw(\"Customer parameter required\")\\n'\n"
                "    'outstanding = frappe.db.sql(\\n'\n"
                "    '    \"\"\"SELECT SUM(outstanding_amount) as total\\n'\n"
                "    '    FROM `tabSales Invoice`\\n'\n"
                "    '    WHERE customer=%s AND docstatus=1\"\"\",\\n'\n"
                "    '    customer, as_dict=True)[0]\\n'\n"
                "    'frappe.response[\"message\"] = {\\n'\n"
                "    '    \"customer\": customer,\\n'\n"
                "    '    \"outstanding\": outstanding.total or 0\\n'\n"
                "    '}'\n"
                "})\n"
                "Access via: GET /api/method/get_customer_outstanding?customer=CustomerName\n\n"
                "C4 — SCHEDULED TASK (CRON):\n"
                "'Har raat 12 baje overdue invoices ka status update karo'\n"
                "create_document(doctype='Server Script', data={\n"
                "  '__newname': 'daily_overdue_invoice_updater',\n"
                "  'script_type': 'Scheduler Event',\n"
                "  'event_frequency': 'Cron',\n"
                "  'cron_format': '0 0 * * *',\n"
                "  'enabled': 1,\n"
                "  'script': 'overdue = frappe.get_all(\"Sales Invoice\",\\n'\n"
                "    '    filters={\"docstatus\": 1, \"outstanding_amount\": [\">\", 0],\\n'\n"
                "    '        \"due_date\": [\"<\", frappe.utils.today()]},\\n'\n"
                "    '    fields=[\"name\"])\\n'\n"
                "    'for inv in overdue:\\n'\n"
                "    '    frappe.db.set_value(\"Sales Invoice\", inv.name, \"status\", \"Overdue\")\\n'\n"
                "    'frappe.db.commit()\\n'\n"
                "    'frappe.logger().info(f\"Updated {len(overdue)} overdue invoices\")'\n"
                "})\n"
                "Cron format: '0 0 * * *' = midnight daily\n"
                "'0 9 * * 1' = 9 AM every Monday\n"
                "'*/30 * * * *' = every 30 minutes\n\n"
                "SEND EMAIL AFTER SUBMIT:\n"
                "'Invoice submit hone pe customer ko email jaye'\n"
                "create_document(doctype='Server Script', data={\n"
                "  '__newname': 'si_email_on_submit',\n"
                "  'script_type': 'DocType Event',\n"
                "  'reference_doctype': 'Sales Invoice',\n"
                "  'doctype_event': 'After Submit',\n"
                "  'enabled': 1,\n"
                "  'script': 'if doc.contact_email:\\n'\n"
                "    '    frappe.sendmail(\\n'\n"
                "    '        recipients=[doc.contact_email],\\n'\n"
                "    '        subject=f\"Invoice {doc.name} — Amount {doc.grand_total}\",\\n'\n"
                "    '        message=f\"Dear {doc.customer_name},<br><br>\"\\n'\n"
                "    '            f\"Your invoice {doc.name} for {doc.grand_total} has been generated.<br>\"\\n'\n"
                "    '            f\"Due date: {doc.due_date}<br><br>Thank you\"\\n'\n"
                "    '    )'\n"
                "})\n\n"
                "SERVER SCRIPT TYPES REFERENCE:\n"
                "- DocType Event: script_type='DocType Event', reference_doctype, doctype_event\n"
                "  Events: Before Insert, After Insert, Before Validate, Before Save, After Save,\n"
                "  Before Submit, After Submit, Before Cancel, After Cancel, Before Delete, After Delete\n"
                "- API: script_type='API', api_method (URL path), allow_guest\n"
                "- Scheduler Event: script_type='Scheduler Event', event_frequency, cron_format\n"
                "  Frequencies: All, Hourly, Daily, Weekly, Monthly, Yearly, Cron\n"
                "- Permission Query: script_type='Permission Query', reference_doctype"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_phase_c_recipes")


def index_phase_def_recipes():
    """Index Phase D (Workflow), E (Print Format), F (Report) recipes."""
    knowledge = [
        {
            "title": "Recipe: Workflow — Approval Chain with States and Transitions",
            "content": (
                "Recipe: Create Workflow for multi-level approval\n\n"
                "CRITICAL: Workflow 'name' is SET BY USER — MUST include '__newname' in data!\n\n"
                "D1 — SIMPLE APPROVAL (Employee → Manager → HR):\n"
                "'Leave Application mein approval workflow chahiye'\n"
                "create_document(doctype='Workflow', data={\n"
                "  '__newname': 'Leave Approval Workflow',\n"
                "  'document_type': 'Leave Application',\n"
                "  'is_active': 1,\n"
                "  'workflow_state_field': 'workflow_state',\n"
                "  'states': [\n"
                "    {'state': 'Pending', 'doc_status': '0', 'allow_edit': 'Employee',\n"
                "     'style': 'Warning'},\n"
                "    {'state': 'Approved', 'doc_status': '1', 'allow_edit': 'HR Manager',\n"
                "     'style': 'Success', 'update_field': 'status', 'update_value': 'Approved'},\n"
                "    {'state': 'Rejected', 'doc_status': '1', 'allow_edit': 'HR Manager',\n"
                "     'style': 'Danger', 'update_field': 'status', 'update_value': 'Rejected'}\n"
                "  ],\n"
                "  'transitions': [\n"
                "    {'state': 'Pending', 'action': 'Approve', 'next_state': 'Approved',\n"
                "     'allowed': 'HR Manager', 'allow_self_approval': 0},\n"
                "    {'state': 'Pending', 'action': 'Reject', 'next_state': 'Rejected',\n"
                "     'allowed': 'HR Manager'}\n"
                "  ]\n"
                "})\n\n"
                "D2 — AMOUNT-BASED MULTI-LEVEL:\n"
                "'PO < 10K auto, 10K-1L manager, > 1L director approve kare'\n"
                "create_document(doctype='Workflow', data={\n"
                "  '__newname': 'PO Approval Workflow',\n"
                "  'document_type': 'Purchase Order',\n"
                "  'is_active': 1,\n"
                "  'workflow_state_field': 'workflow_state',\n"
                "  'states': [\n"
                "    {'state': 'Draft', 'doc_status': '0', 'allow_edit': 'All', 'style': ''},\n"
                "    {'state': 'Pending Manager', 'doc_status': '0', 'allow_edit': 'Purchase Manager',\n"
                "     'style': 'Warning'},\n"
                "    {'state': 'Pending Director', 'doc_status': '0', 'allow_edit': 'All',\n"
                "     'style': 'Danger'},\n"
                "    {'state': 'Approved', 'doc_status': '1', 'allow_edit': 'All', 'style': 'Success'},\n"
                "    {'state': 'Rejected', 'doc_status': '2', 'allow_edit': 'All', 'style': 'Danger'}\n"
                "  ],\n"
                "  'transitions': [\n"
                "    {'state': 'Draft', 'action': 'Submit for Approval',\n"
                "     'next_state': 'Pending Manager', 'allowed': 'All'},\n"
                "    {'state': 'Pending Manager', 'action': 'Approve',\n"
                "     'next_state': 'Approved', 'allowed': 'Purchase Manager',\n"
                "     'condition': 'doc.grand_total <= 100000'},\n"
                "    {'state': 'Pending Manager', 'action': 'Escalate to Director',\n"
                "     'next_state': 'Pending Director', 'allowed': 'Purchase Manager',\n"
                "     'condition': 'doc.grand_total > 100000'},\n"
                "    {'state': 'Pending Director', 'action': 'Approve',\n"
                "     'next_state': 'Approved', 'allowed': 'System Manager'},\n"
                "    {'state': 'Pending Manager', 'action': 'Reject',\n"
                "     'next_state': 'Rejected', 'allowed': 'Purchase Manager'},\n"
                "    {'state': 'Pending Director', 'action': 'Reject',\n"
                "     'next_state': 'Rejected', 'allowed': 'System Manager'}\n"
                "  ]\n"
                "})\n\n"
                "D5 — STATUS TRACKING:\n"
                "'Sales Order: Draft → Confirmed → In Production → Shipped → Delivered'\n"
                "States have doc_status: 0=Draft, 1=Submitted, 2=Cancelled\n"
                "Use update_field + update_value to sync with existing status fields.\n\n"
                "WORKFLOW RULES:\n"
                "- Only ONE active workflow per DocType\n"
                "- workflow_state_field: field that stores current state (auto-created if Custom Field)\n"
                "- condition: JS expression evaluated on transitions\n"
                "- allow_self_approval: 0 = user cannot approve own docs\n"
                "- doc_status transitions: Draft(0)→Submitted(1)→Cancelled(2)\n"
                "- style options: Warning, Primary, Success, Danger, Info, Inverse, ''"
            ),
        },
        {
            "title": "Recipe: Print Format — Custom Invoice and Receipt",
            "content": (
                "Recipe: Create Print Format with Jinja HTML\n\n"
                "E1 — CUSTOM INVOICE PRINT FORMAT:\n"
                "'Sales Invoice ka naya print format banao with company info and items table'\n"
                "create_document(doctype='Print Format', data={\n"
                "  'name': 'Custom Tax Invoice',\n"
                "  'doc_type': 'Sales Invoice',\n"
                "  'module': 'Accounts',\n"
                "  'print_format_type': 'Jinja',\n"
                "  'standard': 'No',\n"
                "  'custom_format': 1,\n"
                "  'html': '<div class=\"print-format\" style=\"font-family: Arial, sans-serif; padding: 20px;\">\\n'\n"
                "    '  <div style=\"text-align: center; margin-bottom: 20px;\">\\n'\n"
                "    '    <h2>{{ doc.company }}</h2>\\n'\n"
                "    '    <h3>TAX INVOICE</h3>\\n'\n"
                "    '    <p>{{ doc.name }}</p>\\n'\n"
                "    '  </div>\\n'\n"
                "    '  <table style=\"width:100%; margin-bottom:15px;\">\\n'\n"
                "    '    <tr><td><strong>Customer:</strong> {{ doc.customer_name }}</td>\\n'\n"
                "    '        <td style=\"text-align:right\"><strong>Date:</strong> {{ frappe.utils.formatdate(doc.posting_date) }}</td></tr>\\n'\n"
                "    '    <tr><td><strong>Address:</strong> {{ doc.address_display or \"\" }}</td>\\n'\n"
                "    '        <td style=\"text-align:right\"><strong>Due Date:</strong> {{ frappe.utils.formatdate(doc.due_date) }}</td></tr>\\n'\n"
                "    '  </table>\\n'\n"
                "    '  <table class=\"table table-bordered\" style=\"width:100%;\">\\n'\n"
                "    '    <thead><tr style=\"background:#f5f5f5;\">\\n'\n"
                "    '      <th>#</th><th>Item</th><th>Qty</th><th>Rate</th><th>Amount</th>\\n'\n"
                "    '    </tr></thead>\\n'\n"
                "    '    <tbody>\\n'\n"
                "    '    {% for item in doc.items %}\\n'\n"
                "    '      <tr>\\n'\n"
                "    '        <td>{{ item.idx }}</td>\\n'\n"
                "    '        <td>{{ item.item_name }}</td>\\n'\n"
                "    '        <td style=\"text-align:right\">{{ item.qty }}</td>\\n'\n"
                "    '        <td style=\"text-align:right\">{{ frappe.utils.fmt_money(item.rate, currency=doc.currency) }}</td>\\n'\n"
                "    '        <td style=\"text-align:right\">{{ frappe.utils.fmt_money(item.amount, currency=doc.currency) }}</td>\\n'\n"
                "    '      </tr>\\n'\n"
                "    '    {% endfor %}\\n'\n"
                "    '    </tbody>\\n'\n"
                "    '  </table>\\n'\n"
                "    '  <div style=\"text-align:right; margin-top:10px;\">\\n'\n"
                "    '    <p><strong>Net Total:</strong> {{ frappe.utils.fmt_money(doc.net_total, currency=doc.currency) }}</p>\\n'\n"
                "    '    {% if doc.total_taxes_and_charges %}<p><strong>Tax:</strong> {{ frappe.utils.fmt_money(doc.total_taxes_and_charges, currency=doc.currency) }}</p>{% endif %}\\n'\n"
                "    '    <h3><strong>Grand Total: {{ frappe.utils.fmt_money(doc.grand_total, currency=doc.currency) }}</strong></h3>\\n'\n"
                "    '    <p><em>{{ frappe.utils.money_in_words(doc.grand_total, doc.currency) }}</em></p>\\n'\n"
                "    '  </div>\\n'\n"
                "    '  <hr>\\n'\n"
                "    '  <p style=\"font-size:11px; color:#666;\">Terms: Payment due within {{ doc.payment_terms_template or \"30 days\" }}</p>\\n'\n"
                "    '</div>'\n"
                "})\n\n"
                "E6 — THERMAL/POS RECEIPT (80mm):\n"
                "Use narrow layout: max-width: 280px, smaller fonts, no table borders.\n\n"
                "PRINT FORMAT TIPS:\n"
                "- Print Format name must be unique\n"
                "- doc: The document object (all fields accessible)\n"
                "- doc.items: Child table rows\n"
                "- frappe.utils.fmt_money(amount, currency): Format currency\n"
                "- frappe.utils.formatdate(date): Format date\n"
                "- frappe.utils.money_in_words(amount, currency): Amount in words\n"
                "- Use Bootstrap classes: table, table-bordered\n"
                "- Test via: /printview?doctype=Sales%20Invoice&name=SI-001&format=Custom%20Tax%20Invoice\n"
                "- Letter Head auto-applied from Print Settings\n"
                "- {% if condition %} for conditional sections\n"
                "- {% for row in doc.items %} for iterating child tables\n"
                "- No bench migrate needed — instant"
            ),
        },
        {
            "title": "Recipe: Reports — Query Report and Script Report",
            "content": (
                "Recipe: Create custom reports\n\n"
                "CRITICAL: Report uses autoname='field:report_name' — NO __newname needed!\n"
                "CRITICAL: 'filters' is a CHILD TABLE of 'Report Filter' — pass as list of dicts!\n"
                "CRITICAL: 'columns' is a CHILD TABLE of 'Report Column' — pass as list of dicts!\n"
                "Report Filter fields: fieldname, label, fieldtype (Select: Date/Data/Link/Int/Float/Select), mandatory (0/1), default, options\n"
                "Report Column fields: fieldname, label, fieldtype (Select: Data/Int/Float/Currency/Link/Date), width, options\n\n"
                "F1 — QUERY REPORT (SQL-based):\n"
                "'Monthly sales report customer-wise'\n"
                "create_document(doctype='Report', data={\n"
                "  'report_name': 'Monthly Sales by Customer',\n"
                "  'ref_doctype': 'Sales Invoice',\n"
                "  'report_type': 'Query Report',\n"
                "  'is_standard': 'No',\n"
                "  'query': 'SELECT si.customer as Customer, COUNT(*) as `Invoice Count`, "
                "SUM(si.grand_total) as `Total Amount` "
                "FROM `tabSales Invoice` si "
                "WHERE si.docstatus = 1 AND si.posting_date BETWEEN %(from_date)s AND %(to_date)s "
                "GROUP BY si.customer ORDER BY SUM(si.grand_total) DESC',\n"
                "  'filters': [\n"
                "    {'fieldname': 'from_date', 'fieldtype': 'Date', 'label': 'From Date', 'mandatory': 1, 'default': 'Today'},\n"
                "    {'fieldname': 'to_date', 'fieldtype': 'Date', 'label': 'To Date', 'mandatory': 1, 'default': 'Today'}\n"
                "  ],\n"
                "  'columns': [\n"
                "    {'fieldname': 'Customer', 'label': 'Customer', 'fieldtype': 'Link', 'options': 'Customer', 'width': 200},\n"
                "    {'fieldname': 'Invoice Count', 'label': 'Invoice Count', 'fieldtype': 'Int', 'width': 120},\n"
                "    {'fieldname': 'Total Amount', 'label': 'Total Amount', 'fieldtype': 'Currency', 'width': 150}\n"
                "  ]\n"
                "})\n\n"
                "F2 — SCRIPT REPORT (Python-based):\n"
                "'Overdue invoices with aging report'\n"
                "create_document(doctype='Report', data={\n"
                "  'report_name': 'Invoice Aging Report',\n"
                "  'ref_doctype': 'Sales Invoice',\n"
                "  'report_type': 'Script Report',\n"
                "  'is_standard': 'No',\n"
                "  'report_script': "
                "'columns = [\\n"
                "  {\"fieldname\": \"invoice\", \"label\": \"Invoice\", \"fieldtype\": \"Link\", \"options\": \"Sales Invoice\", \"width\": 150},\\n"
                "  {\"fieldname\": \"customer\", \"label\": \"Customer\", \"fieldtype\": \"Link\", \"options\": \"Customer\", \"width\": 200},\\n"
                "  {\"fieldname\": \"amount\", \"label\": \"Amount\", \"fieldtype\": \"Currency\", \"width\": 120},\\n"
                "  {\"fieldname\": \"days_overdue\", \"label\": \"Days Overdue\", \"fieldtype\": \"Int\", \"width\": 100}\\n"
                "]\\n\\n"
                "data = frappe.db.sql(\"\"\"\\n"
                "  SELECT name as invoice, customer, grand_total as amount,\\n"
                "    DATEDIFF(CURDATE(), due_date) as days_overdue\\n"
                "  FROM `tabSales Invoice`\\n"
                "  WHERE docstatus=1 AND outstanding_amount > 0 AND due_date < CURDATE()\\n"
                "  ORDER BY days_overdue DESC\\n"
                "\"\"\", as_dict=True)\\n\\n"
                "result = [columns, data]',\n"
                "  'filters': [\n"
                "    {'fieldname': 'from_date', 'fieldtype': 'Date', 'label': 'From Date', 'mandatory': 1}\n"
                "  ]\n"
                "})\n\n"
                "REPORT RULES:\n"
                "- report_name must be unique (auto-used as document name)\n"
                "- Query Report: SQL with %(param)s for filters, columns child table optional\n"
                "- Script Report: Python code in report_script field\n"
                "- filters: CHILD TABLE (Report Filter) — list of dicts with {fieldname, label, fieldtype, mandatory, default, options}\n"
                "- columns: CHILD TABLE (Report Column) — list of dicts with {fieldname, label, fieldtype, width, options}\n"
                "- Access: /app/query-report/Report Name\n"
                "- No bench migrate needed — instant\n"
                "- Use parameterized queries (%(param)s) — NEVER concatenate user input"
            ),
        },
        {
            "title": "Recipe: Notification — Email, System Alert, Reminder",
            "content": (
                "Recipe: Create Notifications for events\n\n"
                "CRITICAL: Notification uses autoname='Prompt' (hash-based) — NO __newname needed!\n"
                "CRITICAL: 'recipients' is a CHILD TABLE of 'Notification Recipient'!\n"
                "Notification Recipient fields: receiver_by_document_field (Select), receiver_by_role (Link to Role), cc, bcc, condition\n\n"
                "G1 — EMAIL NOTIFICATION ON SUBMIT:\n"
                "'SO submit pe customer ko confirmation email jaye'\n"
                "create_document(doctype='Notification', data={\n"
                "  'subject': 'Sales Order {{ doc.name }} Confirmed',\n"
                "  'document_type': 'Sales Order',\n"
                "  'event': 'Submit',\n"
                "  'channel': 'Email',\n"
                "  'recipients': [{'receiver_by_document_field': 'contact_email'}],\n"
                "  'message': 'Dear {{ doc.customer_name }},<br><br>"
                "Your order {{ doc.name }} for {{ doc.grand_total }} has been confirmed.<br>"
                "Expected delivery: {{ doc.delivery_date }}<br><br>"
                "Thank you for your business.',\n"
                "  'enabled': 1\n"
                "})\n\n"
                "G2 — SYSTEM NOTIFICATION:\n"
                "'New Lead aaye toh Sales Manager ko notification'\n"
                "create_document(doctype='Notification', data={\n"
                "  'subject': 'New Lead: {{ doc.lead_name }}',\n"
                "  'document_type': 'Lead',\n"
                "  'event': 'New',\n"
                "  'channel': 'System Notification',\n"
                "  'recipients': [{'receiver_by_role': 'Sales Manager'}],\n"
                "  'message': 'New lead {{ doc.lead_name }} from {{ doc.source or \"unknown\" }}.',\n"
                "  'enabled': 1\n"
                "})\n\n"
                "G3 — SYSTEM NOTIFICATION TO ROLE:\n"
                "'SO submit pe System Manager ko alert'\n"
                "create_document(doctype='Notification', data={\n"
                "  'subject': 'New SO: {{ doc.name }}',\n"
                "  'document_type': 'Sales Order',\n"
                "  'event': 'Submit',\n"
                "  'channel': 'System Notification',\n"
                "  'recipients': [{'receiver_by_role': 'System Manager'}],\n"
                "  'message': 'Sales Order {{ doc.name }} for {{ doc.customer_name }} ({{ doc.grand_total }}) has been submitted.',\n"
                "  'enabled': 1\n"
                "})\n\n"
                "G5 — REMINDER (Days After):\n"
                "'Invoice due date ke 3 din baad reminder'\n"
                "create_document(doctype='Notification', data={\n"
                "  'subject': 'Payment Reminder: {{ doc.name }}',\n"
                "  'document_type': 'Sales Invoice',\n"
                "  'event': 'Days After',\n"
                "  'days_in_advance': -3,\n"
                "  'date_changed': 'due_date',\n"
                "  'channel': 'Email',\n"
                "  'condition': 'doc.outstanding_amount > 0',\n"
                "  'recipients': [{'receiver_by_document_field': 'contact_email'}],\n"
                "  'message': 'Dear {{ doc.customer_name }},<br>"
                "Invoice {{ doc.name }} for {{ doc.grand_total }} is overdue. "
                "Outstanding: {{ doc.outstanding_amount }}.<br>Please pay at earliest.',\n"
                "  'enabled': 1\n"
                "})\n\n"
                "NOTIFICATION EVENTS:\n"
                "- New: When document is created\n"
                "- Save: On every save\n"
                "- Submit: When submitted\n"
                "- Cancel: When cancelled\n"
                "- Days Before: N days before a date field\n"
                "- Days After: N days after a date field\n"
                "- Value Change: When a specific field value changes\n"
                "- Method: Custom Python method\n\n"
                "CHANNELS: Email, System Notification, Slack, SMS\n"
                "RECIPIENTS child table fields: receiver_by_document_field, receiver_by_role, cc, bcc, condition\n"
                "CONDITION: Python expression, e.g. 'doc.status==\"Overdue\"'\n"
                "Templates use Jinja: {{ doc.name }}, {{ doc.field }}"
            ),
        },
        {
            "title": "Recipe: Permissions — Role, User Permission, Field Level",
            "content": (
                "Recipe: Permission management via Dev Mode\n\n"
                "H1 — ROLE PERMISSION (DocType level):\n"
                "Use get_document to check current permissions, then advise. Cannot directly create DocPerm\n"
                "via create_document — permissions are embedded in DocType.\n"
                "For CUSTOM DocTypes: include permissions in DocType creation.\n"
                "For STANDARD DocTypes: guide user to Role Permission Manager (/app/permission-manager).\n\n"
                "H2 — USER PERMISSION (restrict to specific records):\n"
                "'Rahul ko sirf Delhi territory ka data dikhe'\n"
                "create_document(doctype='User Permission', data={\n"
                "  'user': 'rahul@example.com',\n"
                "  'allow': 'Territory',\n"
                "  'for_value': 'Delhi',\n"
                "  'is_default': 1\n"
                "})\n\n"
                "H7 — PERMISSION AUDIT:\n"
                "'Rahul kya access kar sakta hai'\n"
                "Use run_database_query:\n"
                "SELECT parent as doctype, role, `read`, `write`, `create`, `delete`, `submit`\n"
                "FROM `tabDocPerm`\n"
                "WHERE role IN (SELECT role FROM `tabHas Role` WHERE parent='rahul@example.com')\n"
                "AND `read`=1\n"
                "ORDER BY parent\n\n"
                "H6 — SHARE DOCUMENT:\n"
                "Sharing is done via frappe.share — not available as create_document.\n"
                "Guide user to use 'Share' button on the document form, or use API.\n\n"
                "PERMISSION APPROACH:\n"
                "- For DocType-level: Cannot modify via Dev Mode create_document\n"
                "- For User-level restrictions: create_document with 'User Permission'\n"
                "- For field-level: use Property Setter to set permlevel on fields\n"
                "- For custom DocTypes: include permissions array in DocType creation data\n"
                "- Always recommend /app/permission-manager for complex permission changes"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_phase_def_recipes")


def index_phase_ijkl_recipes():
    """Index Phase I (Data Ops), J (Website), K (Integration), L (Debug) recipes."""
    knowledge = [
        {
            "title": "Recipe: Data Operations — Bulk Update, Import, Export, Merge",
            "content": (
                "Recipe: Data operations via Dev Mode\n\n"
                "I1 — BULK UPDATE:\n"
                "'Sab pending SO ka delivery date next Friday karo'\n"
                "Use run_database_query tool:\n"
                "UPDATE `tabSales Order` SET delivery_date='2026-02-20'\n"
                "WHERE docstatus=0 AND status='Draft'\n"
                "Then: SELECT name, delivery_date FROM `tabSales Order` WHERE docstatus=0 LIMIT 10\n"
                "ALWAYS show count before updating. ALWAYS ask confirm for UPDATE/DELETE queries.\n\n"
                "I3 — DATA EXPORT:\n"
                "'All Sales Orders last month — list karo'\n"
                "Use run_database_query or list_documents:\n"
                "SELECT name, customer, grand_total, status, transaction_date\n"
                "FROM `tabSales Order`\n"
                "WHERE transaction_date BETWEEN '2026-01-01' AND '2026-01-31'\n"
                "AND docstatus IN (0,1)\n"
                "ORDER BY transaction_date DESC\n\n"
                "I7 — DATA VALIDATION CHECK:\n"
                "'Check karo kaunse customers mein email missing hai'\n"
                "SELECT name, customer_name, mobile_no\n"
                "FROM `tabCustomer`\n"
                "WHERE (email_id IS NULL OR email_id = '')\n"
                "AND disabled = 0\n\n"
                "I4 — FIND & REPLACE:\n"
                "'Sab documents mein Pvt Ltd ko Private Limited karo'\n"
                "First COUNT: SELECT COUNT(*) FROM `tabCustomer` WHERE customer_name LIKE '%Pvt Ltd%'\n"
                "Then UPDATE: UPDATE `tabCustomer` SET customer_name = REPLACE(customer_name, 'Pvt Ltd', 'Private Limited')\n"
                "WHERE customer_name LIKE '%Pvt Ltd%'\n\n"
                "I5 — MERGE DUPLICATES:\n"
                "Use frappe.rename_doc to merge:\n"
                "Guide user: Tools → Rename → Merge option. Or via console.\n\n"
                "DATA OPERATION RULES:\n"
                "- ALWAYS use run_database_query for bulk operations\n"
                "- ALWAYS show affected count BEFORE executing UPDATE/DELETE\n"
                "- ALWAYS ask confirmation for destructive operations\n"
                "- Use parameterized queries when possible\n"
                "- For imports: guide user to Data Import tool (/app/data-import)\n"
                "- For exports: run SELECT query and present as table"
            ),
        },
        {
            "title": "Recipe: Website — Web Page, Web Form, Portal, Blog",
            "content": (
                "Recipe: Website features via Dev Mode\n\n"
                "J1 — WEB PAGE:\n"
                "'About Us page banao'\n"
                "create_document(doctype='Web Page', data={\n"
                "  'title': 'About Us',\n"
                "  'route': 'about-us',\n"
                "  'published': 1,\n"
                "  'main_section': '<div class=\"container\">\\n'\n"
                "    '<h1>About Our Company</h1>\\n'\n"
                "    '<p>We are a leading provider of quality products and services.</p>\\n'\n"
                "    '<h2>Our Mission</h2>\\n'\n"
                "    '<p>To deliver excellence in every interaction.</p>\\n'\n"
                "    '<h2>Contact Us</h2>\\n'\n"
                "    '<p>Email: info@company.com | Phone: +91 98765 43210</p>\\n'\n"
                "    '</div>'\n"
                "})\n"
                "Access: /about-us\n\n"
                "J2 — WEB FORM (online form for external users):\n"
                "'Customer feedback form banao'\n"
                "create_document(doctype='Web Form', data={\n"
                "  'title': 'Customer Feedback',\n"
                "  'route': 'customer-feedback',\n"
                "  'doc_type': 'Issue',\n"
                "  'published': 1,\n"
                "  'allow_edit': 0,\n"
                "  'login_required': 0,\n"
                "  'success_url': '/thank-you',\n"
                "  'success_message': 'Thank you for your feedback!',\n"
                "  'web_form_fields': [\n"
                "    {'fieldname': 'subject', 'fieldtype': 'Data', 'label': 'Subject', 'reqd': 1},\n"
                "    {'fieldname': 'description', 'fieldtype': 'Text Editor', 'label': 'Your Feedback', 'reqd': 1},\n"
                "    {'fieldname': 'raised_by', 'fieldtype': 'Data', 'label': 'Your Email',\n"
                "     'options': 'Email', 'reqd': 1}\n"
                "  ]\n"
                "})\n"
                "Access: /customer-feedback\n\n"
                "J3 — PORTAL (customer sees own data):\n"
                "Guide user to Portal Settings (/app/portal-settings).\n"
                "Portal pages are auto-generated for Sales Order, Sales Invoice, etc.\n"
                "Customer logs in → sees own documents only.\n"
                "Enable: Portal Settings → Show sidebar items.\n\n"
                "J4 — BLOG:\n"
                "create_document(doctype='Blog Post', data={\n"
                "  'title': 'Welcome to Our Blog',\n"
                "  'blog_category': 'General',\n"
                "  'blogger': 'Administrator',\n"
                "  'published': 1,\n"
                "  'content': '<p>This is our first blog post. Stay tuned for updates!</p>'\n"
                "})\n\n"
                "WEBSITE RULES:\n"
                "- Web Pages: static content, custom HTML\n"
                "- Web Forms: create/edit documents from website (guest or logged-in)\n"
                "- Blog: built-in blogging with categories\n"
                "- All accessible at site_url/route\n"
                "- No bench migrate needed"
            ),
        },
        {
            "title": "Recipe: Integration — Webhook, API, External Services",
            "content": (
                "Recipe: Integration patterns via Dev Mode\n\n"
                "K1 — INCOMING WEBHOOK:\n"
                "'External system se data receive karo'\n"
                "create_document(doctype='Webhook', data={\n"
                "  'webhook_doctype': 'Sales Order',\n"
                "  'webhook_docevent': 'on_submit',\n"
                "  'request_url': 'https://external-system.com/api/webhook',\n"
                "  'request_method': 'POST',\n"
                "  'request_structure': 'Form URL-Encoded',\n"
                "  'webhook_headers': [{'key': 'Authorization', 'value': 'Bearer TOKEN'}],\n"
                "  'webhook_data': [\n"
                "    {'fieldname': 'name', 'key': 'order_id'},\n"
                "    {'fieldname': 'customer', 'key': 'customer_name'},\n"
                "    {'fieldname': 'grand_total', 'key': 'amount'}\n"
                "  ],\n"
                "  'enabled': 1\n"
                "})\n\n"
                "K2 — OUTGOING WEBHOOK (notify external on event):\n"
                "Same as above — Webhook DocType sends data OUT when event fires.\n"
                "Events: after_insert, on_update, on_submit, on_cancel, on_trash\n\n"
                "K5 — PAYMENT GATEWAY:\n"
                "Guide user to Payment Gateway setup in ERPNext settings.\n"
                "Razorpay/PayPal/Stripe configured via ERPNext's built-in Payment Gateway DocType.\n\n"
                "K3 — GOOGLE SHEETS SYNC:\n"
                "Use Server Script (Scheduler Event) + Google Sheets API:\n"
                "- Install gspread via pip\n"
                "- Create API Server Script that reads data and pushes to sheet\n"
                "- Or use Webhook to push on each event\n\n"
                "K4 — WHATSAPP INTEGRATION:\n"
                "Use Server Script (After Submit) + WhatsApp Business API:\n"
                "Server Script calls external API with customer phone + message.\n\n"
                "INTEGRATION APPROACH IN DEV MODE:\n"
                "- Webhook DocType: Best for outgoing notifications on events\n"
                "- Server Script (API): Best for incoming data/endpoints\n"
                "- Server Script (Scheduler): Best for periodic sync\n"
                "- For complex integrations: recommend custom app or hooks.py\n"
                "- Always test webhook URL before enabling\n"
                "- Use frappe.utils.password.get_decrypted_password() for secrets"
            ),
        },
        {
            "title": "Recipe: Debug & Fix — Error Analysis, Performance, Cache",
            "content": (
                "Recipe: Debugging and fixing via Dev Mode\n\n"
                "L1 — ERROR EXPLANATION:\n"
                "'Ye error ka matlab kya hai?'\n"
                "User pastes error → AI explains in simple language:\n"
                "- ValidationError → Required field missing or invalid value\n"
                "- LinkValidationError → Referenced document doesn't exist\n"
                "- MandatoryError → Required field not filled\n"
                "- DuplicateEntryError → Document with same name exists\n"
                "- PermissionError → User doesn't have access\n"
                "- TimestampMismatchError → Document was modified by someone else\n\n"
                "L2 — LOG ANALYSIS:\n"
                "'Last errors dikha'\n"
                "Use run_database_query:\n"
                "SELECT name, method, error, creation\n"
                "FROM `tabError Log`\n"
                "ORDER BY creation DESC\n"
                "LIMIT 10\n\n"
                "L3 — SLOW QUERY CHECK:\n"
                "'Kaunsi queries slow hain?'\n"
                "SELECT name, query, duration, creation\n"
                "FROM `tabSlow Query Log`\n"
                "ORDER BY duration DESC\n"
                "LIMIT 10\n"
                "Note: Slow Query Log may not exist on all setups.\n\n"
                "L4 — FIX SUGGESTIONS:\n"
                "'Document save nahi ho raha'\n"
                "Check approach:\n"
                "1. get_doctype_info → check required fields\n"
                "2. list_documents with filters → check if record exists\n"
                "3. Check Error Log for recent errors\n"
                "4. Common fixes: clear cache, check permissions, check mandatory fields\n\n"
                "L6 — HEALTH CHECK:\n"
                "'System health check karo'\n"
                "Use run_database_query for each:\n"
                "- Error count: SELECT COUNT(*) FROM `tabError Log` WHERE creation > NOW() - INTERVAL 1 HOUR\n"
                "- Scheduled Job status: SELECT name, status, last_execution FROM `tabScheduled Job Type` WHERE status='Failed' LIMIT 5\n"
                "- Active users: SELECT COUNT(DISTINCT user) FROM `tabActivity Log` WHERE creation > NOW() - INTERVAL 1 DAY\n"
                "- DB size: SELECT table_schema, ROUND(SUM(data_length+index_length)/1024/1024, 2) as 'Size (MB)' FROM information_schema.tables GROUP BY table_schema\n\n"
                "L7 — CLEAR CACHE:\n"
                "'Cache clear karo'\n"
                "Guide user: bench clear-cache OR Setup → Clear Cache in UI.\n"
                "For specific: frappe.clear_cache(doctype='Sales Order')\n\n"
                "DEBUG APPROACH:\n"
                "- Always check Error Log first\n"
                "- Explain errors in simple language (Hindi/English)\n"
                "- Suggest fix, don't just describe problem\n"
                "- For persistent issues: check permissions, cache, mandatory fields\n"
                "- For performance: check indexes, query optimization"
            ),
        },
    ]
    return _index_chunks(knowledge, "dev_phase_ijkl_recipes")


def index_markdown_guide():
    """Index the comprehensive Frappe developer guide markdown file.

    Splits by ## headings into chunks for better retrieval.
    """
    import os
    from .rag import add_documents, delete_by_source

    source = "dev_markdown_guide"
    delete_by_source(source)

    # Find the guide file relative to this module
    guide_path = os.path.join(
        os.path.dirname(os.path.dirname(os.path.abspath(__file__))),
        "knowledge", "frappe_developer_guide.md"
    )
    if not os.path.exists(guide_path):
        print("[DEV RAG] frappe_developer_guide.md not found, skipping")
        return 0

    with open(guide_path, "r", encoding="utf-8") as f:
        content = f.read()

    # Split by ## headings
    import re
    sections = re.split(r'\n(?=## )', content)

    texts = []
    metadatas = []
    for section in sections:
        section = section.strip()
        if not section or len(section) < 50:
            continue
        # Extract title from first line
        first_line = section.split('\n', 1)[0].strip('#').strip()
        # Chunk large sections
        from .rag import _chunk_text
        chunks = _chunk_text(section, chunk_size=1500, overlap=200)
        for chunk in chunks:
            texts.append(chunk)
            metadatas.append({"source": source, "title": first_line})

    count = add_documents(texts, metadatas)
    print("[DEV RAG] {}: {} chunks from markdown guide".format(source, count))
    return count
